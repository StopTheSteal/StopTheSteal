######################################################################################################
#
#AL
#AK = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/AKGeneral-latest.json
#AZ
#AR = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/ARGeneral-latest.json
#CA
#CO = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/COGeneral-latest.json
#CT
#DC
#DE = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/DEGeneral-latest.json
#FL = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/FLGeneralConcatenator-latest.json
#GA = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/GAGeneral-latest.json
#HI = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/HIGeneral-latest.json
#IL
#IN
#IA
#KS
#KY = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/KYGeneral-latest.json
#LA = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/LAGeneral-latest.json
#ME
#MD
#MA
#MI = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/MIGeneralConcatenator-latest.json
#MN = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/MNGeneral-latest.json
#MS
#MO
#MT = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/MTGeneral-latest.json
#NE = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/NEGeneral-latest.json
#NV
#NH
#NJ
#NM = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/NMGeneral-latest.json
#NY
#NC = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/NCGeneral-latest.json
#ND = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/NDGeneral-latest.json
#OH
#OK = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/OKGeneral-latest.json
#OR
#PA = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/PAGeneralConcatenator-latest.json
#RI
#SC = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/SCGeneral-latest.json
#SD = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/SDGeneral-latest.json
#TN
#TX
#UT
#VT
#VA
#WA = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/WAGeneral-latest.json
#WV = https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/WVGeneral-latest.json
#WI
#WY
#
######################################################################################################
#
#|SA|P|START|END|LINK TO LINKS|COMMENT|
#|AK|1|||||
#|AR|1|||||
#|CO|1|||||
#|DE|1|||||
#|FL|2|2020-11-01T20:23:41.048Z|2020-11-10T14:29:02.422Z|https://pastebin.com/ai9skssU
#|GA|1|2020-10-31T22:14:05.096Z|2020-11-11T22:32:34.439Z|https://pastebin.com/CD05B8fw
#|HI|1|||||
#|KY|1|||||
#|LA|1|||||
#|MI|2|2020-11-03T19:39:31.715Z|2020-11-10T19:13:08.066Z|https://pastebin.com/W4h6FSPi
#|MN|1|||||
#|MT|1|||||
#|NE|1|||||
#|NM|1|||||
#|NC|1|2020-10-30T13:19:01.425Z|2020-11-11T21:21:55.407Z|https://pastebin.com/stpeXHYE
#|ND|1|||||
#|OK|1|||||
#|PA|2|2020-11-03T19:39:48.428Z|2020-11-11T21:50:46.218Z|https://pastebin.com/5xBeaQzh
#|SC|1|||||
#|SD|1|||||
#|WA|1|||||
#|WV|1|||||
#
# P in {1,2} => {"General-", "GeneralConcatenator-"}
# START <= T <= END or T = "latest"
# Links: "https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts/{SA}{P}{T}.json"
#
######################################################################################################

json_url_base <- "https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/race-page"
my_github_base <- "https://github.com/StopTheSteal/StopTheSteal/tree/main/Analytics/Scripts/r"

president_state_strings <- c("alabama", "alaska", "arizona", "arkansas", "california",
                             "colorado", "connecticut", "delaware", "district-of-columbia", "florida",
                             "georgia", "hawaii", "idaho", "illinois", "indiana",
                             "iowa", "kansas", "kentucky", "louisiana", "maine",
                             "maryland", "massachusetts", "michigan", "minnesota", "mississippi",
                             "missouri", "montana", "nebraska", "nevada", "new-hampshire",
                             "new-jersey", "new-mexico", "new-york", "north-carolina", "north-dakota",
                             "ohio", "oklahoma", "oregon", "pennsylvania", "rhode-island",
                             "south-carolina", "south-dakota", "tennessee", "texas", "utah",
                             "vermont", "virginia", "washington", "west-virginia", "wisconsin",
                             "wyoming")

senate_state_strings <- c("alabama", "alaska", "arkansas", "colorado", "delaware", "georgia", 
                          "idaho", "illinois", "iowa", "kansas", "kentucky", "louisiana", 
                          "maine",
                          #"massachusetts", # missing data
                          "michigan", "minnesota", "mississippi", 
                          "montana", "nebraska", "new-hampshire", "new-jersey", "new-mexico", 
                          "north-carolina", "oklahoma", "oregon", "rhode-island", "south-carolina", 
                          "south-dakota", "tennessee", "texas", "virginia", "west-virginia", 
                          "wyoming")

special_state_strings <- c("arizona", "georgia")

race_strings <- c("president", "senate", "special")

list_state_to_abbr <- list(alabama = "al", alaska = "ak", arizona = "az", arkansas = "ar", california = "ca",
                           colorado = "co", connecticut = "ct", delaware = "de", `district-of-columbia` = "dc", florida = "fl",
                           georgia = "ga", hawaii = "hi", idaho = "id", illinois ="il", indiana = "in",
                           iowa = "ia", kansas = "ks", kentucky = "ky", louisiana = "la", maine = "me",
                           maryland = "md", massachusetts = "ma", michigan = "mi", minnesota = "mn", mississippi = "ms",
                           missouri = "mo", montana = "mt", nebraska = "ne", nevada = "nv", `new-hampshire` = "nh",
                           `new-jersey` = "nj", `new-mexico` = "nm", `new-york` = "ny", `north-carolina` = "nc", `north-dakota` = "nd",
                           ohio = "oh", oklahoma = "ok", oregon = "or", pennsylvania = "pa", `rhode-island` = "ri",
                           `south-carolina` = "sc", `south-dakota` = "sd", tennessee = "tn", texas = "tx", utah = "ut",
                           vermont = "vt", virginia = "va", washington = "wa", `west-virginia` = "wv", wisconsin = "wi",
                           wyoming = "wy")

list_state_to_interval <- list(
  alabama                = list(from = "2020-11-04T01:00:00Z", to = "2020-11-04T22:00:00Z"), # Done (1)
  alaska                 = list(from = "2020-11-04T05:00:00Z", to = "2020-12-03T20:00:00Z"), # Done (2)
  arizona                = list(from = "2020-11-04T02:00:00Z", to = "2020-11-12T06:00:00Z"), # Done (3)
  arkansas               = list(from = "2020-11-04T01:00:00Z", to = "2020-11-04T23:00:00Z"), # Done (4)
  california             = list(from = "2020-11-04T04:00:00Z", to = "2020-11-27T20:00:00Z"), # Done (5)
  colorado               = list(from = "2020-11-04T02:00:00Z", to = "2020-11-07T02:00:00Z"), # Done (6)
  connecticut            = list(from = "2020-11-04T01:00:00Z", to = "2020-11-07T22:00:00Z"), # Done (7)
  delaware               = list(from = "2020-11-04T01:00:00Z", to = "2020-11-04T07:00:00Z"), # Done (8)
  `district-of-columbia` = list(from = "2020-11-04T01:00:00Z", to = "2020-11-26T00:00:00Z"), # Done (9)
  florida                = list(from = "2020-11-04T00:00:00Z", to = "2020-11-04T06:00:00Z"), # Done (10)
  georgia                = list(from = "2020-11-04T03:00:00Z", to = "2020-11-10T00:00:00Z"), # Done (11)
  hawaii                 = list(from = "2020-11-04T08:00:00Z", to = "2020-11-04T18:00:00Z"), # Done (12)
  idaho                  = list(from = "2020-11-04T03:00:00Z", to = "2020-11-05T02:00:00Z"), # Done (13)
  illinois               = list(from = "2020-11-04T01:00:00Z", to = "2020-11-17T20:00:00Z"), # Done (14)
  indiana                = list(from = "2020-11-03T23:00:00Z", to = "2020-11-06T22:00:00Z"), # Done (15)
  iowa                   = list(from = "2020-11-04T03:00:00Z", to = "2020-11-04T11:00:00Z"), # Done (16)
  kansas                 = list(from = "2020-11-04T01:00:00Z", to = "2020-11-10T20:00:00Z"), # Done (17)
  kentucky               = list(from = "2020-11-03T23:00:00Z", to = "2020-11-07T00:00:00Z"), # Done (18)
  louisiana              = list(from = "2020-11-04T02:00:00Z", to = "2020-11-04T06:00:00Z"), # Done (19)
  maine                  = list(from = "2020-11-04T01:00:00Z", to = "2020-11-10T20:00:00Z"), # Done (20)
  maryland               = list(from = "2020-11-04T02:00:00Z", to = "2020-11-24T20:00:00Z"), # Done (21)
  massachusetts          = list(from = "2020-11-04T01:00:00Z", to = "2020-11-07T20:00:00Z"), # Done (22)
  michigan               = list(from = "2020-11-04T01:00:00Z", to = "2020-11-05T20:00:00Z"), # Done (23) !!!
  minnesota              = list(from = "2020-11-04T02:00:00Z", to = "2020-11-04T11:00:00Z"), # Done (24)
  mississippi            = list(from = "2020-11-04T01:00:00Z", to = "2020-11-17T20:00:00Z"), # Done (25)
  missouri               = list(from = "2020-11-04T01:00:00Z", to = "2020-11-04T08:00:00Z"), # Done (26)
  montana                = list(from = "2020-11-04T03:00:00Z", to = "2020-11-05T21:00:00Z"), # Done (27)
  nebraska               = list(from = "2020-11-04T01:00:00Z", to = "2020-11-05T02:00:00Z"), # Done (28)
  nevada                 = list(from = "2020-11-04T04:00:00Z", to = "2020-11-14T16:00:00Z"), # Done (29)
  `new-hampshire`        = list(from = "2020-11-03T20:00:00Z", to = "2020-11-05T05:00:00Z"), # Done (30)
  `new-jersey`           = list(from = "2020-11-04T01:00:00Z", to = "2020-11-17T20:00:00Z"), # Done (31)
  `new-mexico`           = list(from = "2020-11-04T02:00:00Z", to = "2020-11-04T08:00:00Z"), # Done (32)
  `new-york`             = list(from = "2020-11-04T02:00:00Z", to = "2020-12-05T20:00:00Z"), # Done (33)
  `north-carolina`       = list(from = "2020-11-04T00:00:00Z", to = "2020-11-04T04:00:00Z"), # Done (34)
  `north-dakota`         = list(from = "2020-11-04T01:00:00Z", to = "2020-11-04T12:00:00Z"), # Done (35)
  ohio                   = list(from = "2020-11-04T00:00:00Z", to = "2020-11-04T07:00:00Z"), # Done (36)
  oklahoma               = list(from = "2020-11-04T01:00:00Z", to = "2020-11-04T07:00:00Z"), # Done (37)
  oregon                 = list(from = "2020-11-04T04:00:00Z", to = "2020-11-06T03:00:00Z"), # Done (38)
  pennsylvania           = list(from = "2020-11-04T00:00:00Z", to = "2020-11-13T00:00:00Z"), # Done (39)!!!
  `rhode-island`         = list(from = "2020-11-04T01:00:00Z", to = "2020-11-07T00:00:00Z"), # Done (40)
  `south-carolina`       = list(from = "2020-11-04T00:00:00Z", to = "2020-11-05T22:00:00Z"), # Done (41)
  `south-dakota`         = list(from = "2020-11-04T02:00:00Z", to = "2020-11-05T03:00:00Z"), # Done (42)
  tennessee              = list(from = "2020-11-04T01:00:00Z", to = "2020-11-04T10:00:00Z"), # Done (43)
  texas                  = list(from = "2020-11-04T00:00:00Z", to = "2020-11-04T12:00:00Z"), # Done (44)
  utah                   = list(from = "2020-11-04T03:00:00Z", to = "2020-11-15T20:00:00Z"), # Done (45)
  vermont                = list(from = "2020-11-04T00:00:00Z", to = "2020-11-12T18:00:00Z"), # Done (46)
  virginia               = list(from = "2020-11-04T00:00:00Z", to = "2020-11-04T12:00:00Z"), # Done (47)
  washington             = list(from = "2020-11-04T03:00:00Z", to = "2020-11-17T20:00:00Z"), # Done (48)
  `west-virginia`        = list(from = "2020-11-04T00:00:00Z", to = "2020-11-14T18:00:00Z"), # Done (49)
  wisconsin              = list(from = "2020-11-04T02:00:00Z", to = "2020-11-04T13:00:00Z"), # Done (50)!!!
  wyoming                = list(from = "2020-11-04T02:00:00Z", to = "2020-11-04T10:00:00Z")  # Done (51)
)

list_state_to_sen_cand_rep <- list(
  alabama          = "vote_shares_tubervillet", # Tuberville
  alaska           = "vote_shares_sullivand",   # Sullivan
  arkansas         = "vote_shares_cottont",     # Cotton
  colorado         = "vote_shares_gardnerc",    # Gardner
  delaware         = "vote_shares_witzkel",     # Witzke
  georgia          = "vote_shares_perdued",     # Perdue
  idaho            = "vote_shares_rischj",      # Risch
  illinois         = "vote_shares_curranm",     # Curran
  iowa             = "vote_shares_ernstj",      # Ernst
  kansas           = "vote_shares_marshallr",   # Marshall
  kentucky         = "vote_shares_mcconnellm",  # McConnell
  louisiana        = "vote_shares_cassidyb",    # Cassidy, Murphy (vote_shares_murphyd)
  maine            = "vote_shares_collinss",    # Collins
  #massachusetts    = "",                       # O'Connor; missing data
  michigan         = "vote_shares_jamesj",      # James
  minnesota        = "vote_shares_lewisj",      # Lewis
  mississippi      = "vote_shares_hyde_smithc", # Hyde-Smith
  montana          = "vote_shares_dainess",     # Daines
  nebraska         = "vote_shares_sasseb",      # Sasse
  `new-hampshire`  = "vote_shares_messnerc",    # Messner
  `new-jersey`     = "vote_shares_mehtar",      # Mehta
  `new-mexico`     = "vote_shares_ronchettim",  # Ronchetti
  `north-carolina` = "vote_shares_tillist",     # Tillis
  oklahoma         = "vote_shares_inhofej",     # Inhofe
  oregon           = "vote_shares_perkinsj",    # Perkins
  `rhode-island`   = "vote_shares_watersa",     # Waters
  `south-carolina` = "vote_shares_grahaml",     # Graham
  `south-dakota`   = "vote_shares_roundsm",     # Rounds
  tennessee        = "vote_shares_hagertyb",    # Hagerty
  texas            = "vote_shares_cornynj",     # Cornyn
  virginia         = "vote_shares_gaded",       # Gade
  `west-virginia`  = "vote_shares_capitos",     # Capito  (the fix is hardcoded)
  wyoming          = "vote_shares_lummisc"      # Lummis
)
list_state_to_sen_cand_dem <- list(
  alabama          = "vote_shares_jonesd",        # Jones
  alaska           = "vote_shares_grossa",        # Gross
  arkansas         = "vote_shares_harringtonr",   # Harrington
  colorado         = "vote_shares_hickenlooperj", # Hickenlooper
  delaware         = "vote_shares_coonsc",        # Coons
  georgia          = "vote_shares_ossoffj",       # Ossoff
  idaho            = "vote_shares_jordanp",       # Jordan
  illinois         = "vote_shares_durbinr",       # Durbin
  iowa             = "vote_shares_greenfieldt",   # Greenfield
  kansas           = "vote_shares_bollierb",      # Bollier
  kentucky         = "vote_shares_mcgratha",      # McGrath
  louisiana        = "vote_shares_piercea",       # Perkins, Edwards (vote_shares_wenstrupp), Pierce (vote_shares_perkinsa)
  maine            = "vote_shares_gideons",       # Gideon
  #massachusetts    = "",                         # Markey; missing data
  michigan         = "vote_shares_petersg",       # Peters
  minnesota        = "vote_shares_smitht",        # Smith
  mississippi      = "vote_shares_espym",         # Espy
  montana          = "vote_shares_bullocks",      # Bullock
  nebraska         = "vote_shares_janicekc",      # Janicek
  `new-hampshire`  = "vote_shares_shaheenj",      # Shaheen
  `new-jersey`     = "vote_shares_bookerc",       # Booker
  `new-mexico`     = "vote_shares_lujanm",        # Lujan (the fix is hardcoded)
  `north-carolina` = "vote_shares_cunninghamc",   # Cunningham
  oklahoma         = "vote_shares_broylesa",      # Broyles
  oregon           = "vote_shares_merkleyj",      # Merkley
  `rhode-island`   = "vote_shares_reedj",         # Reed
  `south-carolina` = "vote_shares_harrisonj",     # Harrison
  `south-dakota`   = "vote_shares_ahlersd",       # Ahlers
  tennessee        = "vote_shares_bradshawm",     # Bradshaw
  texas            = "vote_shares_hegarm",        # Hegar
  virginia         = "vote_shares_warnerm",       # Warner
  `west-virginia`  = "vote_shares_swearenginp",   # Swearengin
  wyoming          = "vote_shares_ben_davidm"     # Ben-David
)

list_state_to_spec_cand_rep <- list(arizona = "vote_shares_mcsallym",
                                    georgia = "vote_shares_loefflerk" # hard-coded: georgia += "vote_shares_collinsd"
                                    )
list_state_to_spec_cand_dem <- list(arizona = "vote_shares_kellym",
                                    georgia = "vote_shares_warnockr"
                                    )


######################################################################################################
url_template <- "https://static01.nyt.com/elections-assets/2020/data/api/2020-11-03/precincts"
file_extension <- ".json"
str_latest_snapshot_timestamp <- "2020-12-01T11:59:59.999Z"

arrStateAbbrs <- c("AK","AR","CO","DE","FL","GA","HI","KY","LA","MI","MN","MT","NE","NM","NC","ND","OK","PA","SC","SD","WA","WV")
arrStateNames <- c(
  "Alaska", # AK
  "Arkansas", # AR
  "Colorado", # CO
  "Delaware", # DE
  "Florida", # FL
  "Georgia", # GA
  "Hawaii", # HI
  "Kentucky", # KY
  "Louisiana", # LA
  "Michigan", # MI
  "Minnesota", # MN
  "Montana", # MT
  "Nebraska", # NE
  "New Mexico", # NM
  "North Carolina", # NC
  "North Dakota", # ND
  "Oklahoma", # OK
  "Pennsylvania", # PA
  "South Carolina", # SC
  "South Dakota", # SD
  "Washington", # WA
  "West Virginia" # WV
  )

list_file_prefixes <- list(
  AK = "AKGeneral-",
  AR = "ARGeneral-",
  CO = "COGeneral-",
  DE = "DEGeneral-",
  FL = "FLGeneralConcatenator-",
  GA = "GAGeneral-",
  HI = "HIGeneral-",
  KY = "KYGeneral-",
  LA = "LAGeneral-",
  MI = "MIGeneralConcatenator-",
  MN = "MNGeneral-",
  MT = "MTGeneral-",
  NE = "NEGeneral-",
  NM = "NMGeneral-",
  NC = "NCGeneral-",
  ND = "NDGeneral-",
  OK = "OKGeneral-",
  PA = "PAGeneralConcatenator-",
  SC = "SCGeneral-",
  SD = "SDGeneral-",
  WA = "WAGeneral-",
  WV = "WVGeneral-"
  )

list_file_postfixes <- list(
  AK = c(
    "latest"),
  AR = c(
    "latest"),
  CO = c(
    "latest"),
  DE = c(
    "latest"),
  FL = c(
    "2020-11-01T20:23:41.048Z",
    "2020-11-03T19:10:34.753Z",
    "2020-11-03T19:48:11.132Z",
    "2020-11-03T20:50:09.655Z",
    "2020-11-03T21:32:43.796Z",
    "2020-11-03T23:04:20.734Z",
    "2020-11-03T23:09:18.088Z",
    "2020-11-03T23:37:11.444Z",
    "2020-11-04T00:00:48.405Z",
    "2020-11-04T00:03:37.485Z",
    "2020-11-04T00:10:02.552Z",
    "2020-11-04T00:12:21.206Z",
    "2020-11-04T00:13:43.838Z",
    "2020-11-04T00:15:39.143Z",
    "2020-11-04T00:18:33.119Z",
    "2020-11-04T00:21:51.792Z",
    "2020-11-04T00:24:52.396Z",
    "2020-11-04T00:27:42.448Z",
    "2020-11-04T00:28:05.627Z",
    "2020-11-04T00:30:42.764Z",
    "2020-11-04T00:33:24.144Z",
    "2020-11-04T00:33:44.745Z",
    "2020-11-04T00:35:16.415Z",
    "2020-11-04T00:36:23.570Z",
    "2020-11-04T00:38:17.497Z",
    "2020-11-04T00:44:27.754Z",
    "2020-11-04T00:45:26.909Z",
    "2020-11-04T00:47:28.478Z",
    "2020-11-04T00:50:00.345Z",
    "2020-11-04T00:51:58.786Z",
    "2020-11-04T00:58:51.133Z",
    "2020-11-04T00:59:14.272Z",
    "2020-11-04T01:00:21.243Z",
    "2020-11-04T01:12:04.727Z",
    "2020-11-04T01:12:53.879Z",
    "2020-11-04T01:16:10.725Z",
    "2020-11-04T01:17:02.012Z",
    "2020-11-04T01:20:41.027Z",
    "2020-11-04T01:21:33.914Z",
    "2020-11-04T01:24:16.746Z",
    "2020-11-04T01:24:53.938Z",
    "2020-11-04T01:25:44.118Z",
    "2020-11-04T01:26:23.413Z",
    "2020-11-04T01:28:44.134Z",
    "2020-11-04T01:30:11.909Z",
    "2020-11-04T01:31:30.510Z",
    "2020-11-04T01:35:03.081Z",
    "2020-11-04T01:36:28.405Z",
    "2020-11-04T01:37:46.139Z",
    "2020-11-04T01:38:22.598Z",
    "2020-11-04T01:41:28.807Z",
    "2020-11-04T01:50:19.922Z",
    "2020-11-04T01:51:42.506Z",
    "2020-11-04T01:53:14.176Z",
    "2020-11-04T01:53:52.991Z",
    "2020-11-04T01:54:42.310Z",
    "2020-11-04T01:57:32.517Z",
    "2020-11-04T02:00:12.109Z",
    "2020-11-04T02:00:48.754Z",
    "2020-11-04T02:02:22.581Z",
    "2020-11-04T02:03:13.575Z",
    "2020-11-04T02:03:55.025Z",
    "2020-11-04T02:04:45.775Z",
    "2020-11-04T02:08:57.110Z",
    "2020-11-04T02:12:07.612Z",
    "2020-11-04T02:12:27.397Z",
    "2020-11-04T02:16:50.147Z",
    "2020-11-04T02:20:53.843Z",
    "2020-11-04T02:22:40.855Z",
    "2020-11-04T02:24:11.769Z",
    "2020-11-04T02:32:59.675Z",
    "2020-11-04T02:38:08.326Z",
    "2020-11-04T02:43:24.418Z",
    "2020-11-04T02:45:21.536Z",
    "2020-11-04T02:47:18.199Z",
    "2020-11-04T02:48:43.018Z",
    "2020-11-04T02:50:11.759Z",
    "2020-11-04T02:53:22.081Z",
    "2020-11-04T02:57:08.628Z",
    "2020-11-04T02:59:13.857Z",
    "2020-11-04T03:00:00.532Z",
    "2020-11-04T03:08:40.767Z",
    "2020-11-04T03:11:32.388Z",
    "2020-11-04T03:16:35.365Z",
    "2020-11-04T03:20:25.890Z",
    "2020-11-04T03:22:25.629Z",
    "2020-11-04T03:26:33.799Z",
    "2020-11-04T03:28:28.618Z",
    "2020-11-04T03:29:17.241Z",
    "2020-11-04T03:30:46.613Z",
    "2020-11-04T03:35:08.910Z",
    "2020-11-04T03:36:36.109Z",
    "2020-11-04T03:39:27.841Z",
    "2020-11-04T03:48:43.461Z",
    "2020-11-04T03:52:49.349Z",
    "2020-11-04T04:00:03.924Z",
    "2020-11-04T04:04:21.571Z",
    "2020-11-04T04:15:31.830Z",
    "2020-11-04T04:18:56.741Z",
    "2020-11-04T04:21:00.749Z",
    "2020-11-04T04:21:49.675Z",
    "2020-11-04T04:22:35.959Z",
    "2020-11-04T04:24:32.981Z",
    "2020-11-04T04:28:34.358Z",
    "2020-11-04T04:38:40.426Z",
    "2020-11-04T04:46:18.520Z",
    "2020-11-04T04:53:20.946Z",
    "2020-11-04T04:55:23.106Z",
    "2020-11-04T05:01:07.798Z",
    "2020-11-04T05:27:57.850Z",
    "2020-11-04T05:28:52.237Z",
    "2020-11-04T05:35:41.448Z",
    "2020-11-04T05:41:32.007Z",
    "2020-11-04T05:48:00.214Z",
    "2020-11-04T05:59:57.020Z",
    "2020-11-04T06:23:43.422Z",
    "2020-11-04T06:33:23.353Z",
    "2020-11-04T06:50:40.722Z",
    "2020-11-04T07:05:04.943Z",
    "2020-11-04T09:25:21.242Z",
    "2020-11-04T10:34:53.284Z",
    "2020-11-04T17:14:35.539Z",
    "2020-11-04T22:34:48.379Z",
    "2020-11-04T23:35:41.100Z",
    "2020-11-05T00:04:58.380Z",
    "2020-11-05T01:05:30.965Z",
    "2020-11-05T04:20:19.803Z",
    "2020-11-05T20:22:36.945Z",
    "2020-11-05T22:24:25.645Z",
    "2020-11-05T23:25:03.071Z",
    "2020-11-06T00:22:52.696Z",
    "2020-11-06T00:53:56.979Z",
    "2020-11-06T01:24:37.653Z",
    "2020-11-06T04:22:44.313Z",
    "2020-11-06T13:28:12.292Z",
    "2020-11-06T13:58:39.718Z",
    "2020-11-06T14:06:25.012Z",
    "2020-11-06T14:36:38.751Z",
    "2020-11-06T15:37:04.873Z",
    "2020-11-06T18:27:49.469Z",
    "2020-11-06T19:28:11.893Z",
    "2020-11-06T20:29:29.916Z",
    "2020-11-06T21:30:02.453Z",
    "2020-11-06T22:30:30.387Z",
    "2020-11-06T23:30:33.177Z",
    "2020-11-07T02:16:44.599Z",
    "2020-11-07T02:18:09.291Z",
    "2020-11-07T06:19:56.520Z",
    "2020-11-07T08:20:23.844Z",
    "2020-11-07T09:21:15.820Z",
    "2020-11-07T10:21:09.378Z",
    "2020-11-07T11:00:21.420Z",
    "2020-11-07T14:57:53.819Z",
    "2020-11-07T16:18:20.093Z",
    "2020-11-07T17:18:10.631Z",
    "2020-11-07T23:19:49.400Z",
    "2020-11-08T11:25:15.610Z",
    "2020-11-08T17:30:26.828Z",
    "2020-11-08T19:31:21.730Z",
    "2020-11-09T00:30:32.646Z",
    "2020-11-09T14:30:22.038Z",
    "2020-11-09T18:45:28.481Z",
    "2020-11-09T22:29:39.433Z",
    "2020-11-10T14:29:02.422Z",
    "latest"),
  GA = c(
    "2020-10-31T22:14:05.096Z",
    "2020-11-03T23:40:53.085Z",
    "2020-11-04T00:11:04.659Z",
    "2020-11-04T00:14:43.743Z",
    "2020-11-04T00:23:31.696Z",
    "2020-11-04T00:29:22.735Z",
    "2020-11-04T00:32:55.655Z",
    "2020-11-04T00:36:15.190Z",
    "2020-11-04T00:40:38.045Z",
    "2020-11-04T00:44:14.837Z",
    "2020-11-04T00:49:02.518Z",
    "2020-11-04T00:56:34.218Z",
    "2020-11-04T01:11:35.765Z",
    "2020-11-04T01:15:08.661Z",
    "2020-11-04T01:20:20.753Z",
    "2020-11-04T01:23:55.615Z",
    "2020-11-04T01:27:12.356Z",
    "2020-11-04T01:30:29.565Z",
    "2020-11-04T01:34:00.886Z",
    "2020-11-04T01:38:52.336Z",
    "2020-11-04T01:45:42.861Z",
    "2020-11-04T01:49:04.134Z",
    "2020-11-04T01:52:34.456Z",
    "2020-11-04T01:56:18.161Z",
    "2020-11-04T02:01:58.313Z",
    "2020-11-04T02:05:29.854Z",
    "2020-11-04T02:08:55.234Z",
    "2020-11-04T02:12:37.171Z",
    "2020-11-04T02:19:26.324Z",
    "2020-11-04T02:29:42.004Z",
    "2020-11-04T02:33:11.219Z",
    "2020-11-04T02:41:14.449Z",
    "2020-11-04T02:46:06.870Z",
    "2020-11-04T02:49:39.620Z",
    "2020-11-04T02:52:55.599Z",
    "2020-11-04T02:56:32.639Z",
    "2020-11-04T03:03:24.419Z",
    "2020-11-04T03:06:54.312Z",
    "2020-11-04T03:13:51.629Z",
    "2020-11-04T03:17:19.148Z",
    "2020-11-04T03:20:34.505Z",
    "2020-11-04T03:24:10.344Z",
    "2020-11-04T03:27:42.166Z",
    "2020-11-04T03:30:59.136Z",
    "2020-11-04T03:34:33.240Z",
    "2020-11-04T03:44:50.959Z",
    "2020-11-04T03:48:14.202Z",
    "2020-11-04T03:51:55.686Z",
    "2020-11-04T03:55:18.934Z",
    "2020-11-04T03:58:34.653Z",
    "2020-11-04T04:02:03.338Z",
    "2020-11-04T04:12:27.373Z",
    "2020-11-04T04:15:39.425Z",
    "2020-11-04T04:20:37.325Z",
    "2020-11-04T04:27:23.343Z",
    "2020-11-04T04:34:58.304Z",
    "2020-11-04T04:38:29.842Z",
    "2020-11-04T04:41:59.353Z",
    "2020-11-04T04:50:23.440Z",
    "2020-11-04T04:53:38.018Z",
    "2020-11-04T04:57:08.375Z",
    "2020-11-04T05:24:05.704Z",
    "2020-11-04T05:30:57.333Z",
    "2020-11-04T05:37:29.716Z",
    "2020-11-04T05:57:49.547Z",
    "2020-11-04T06:22:35.850Z",
    "2020-11-04T06:32:43.820Z",
    "2020-11-04T06:36:11.798Z",
    "2020-11-04T07:07:24.747Z",
    "2020-11-04T07:54:09.490Z",
    "2020-11-04T08:00:51.135Z",
    "2020-11-04T16:04:20.496Z",
    "2020-11-04T16:34:36.899Z",
    "2020-11-04T16:38:01.441Z",
    "2020-11-04T17:15:13.003Z",
    "2020-11-04T17:49:16.581Z",
    "2020-11-04T18:33:42.439Z",
    "2020-11-04T18:37:00.257Z",
    "2020-11-04T19:14:29.968Z",
    "2020-11-04T19:33:11.813Z",
    "2020-11-04T19:36:30.548Z",
    "2020-11-04T19:43:33.346Z",
    "2020-11-04T20:13:43.265Z",
    "2020-11-04T20:33:48.294Z",
    "2020-11-04T20:40:26.820Z",
    "2020-11-04T21:00:55.364Z",
    "2020-11-04T21:36:30.623Z",
    "2020-11-04T22:03:20.144Z",
    "2020-11-04T22:24:19.487Z",
    "2020-11-04T22:57:07.964Z",
    "2020-11-04T23:50:14.678Z",
    "2020-11-05T00:16:45.271Z",
    "2020-11-05T00:49:19.907Z",
    "2020-11-05T01:12:58.564Z",
    "2020-11-05T01:34:29.088Z",
    "2020-11-05T02:00:33.912Z",
    "2020-11-05T02:18:47.641Z",
    "2020-11-05T03:07:55.519Z",
    "2020-11-05T04:24:13.870Z",
    "2020-11-05T05:21:51.596Z",
    "2020-11-05T06:07:41.776Z",
    "2020-11-05T10:52:28.118Z",
    "2020-11-05T14:01:18.864Z",
    "2020-11-05T14:49:55.350Z",
    "2020-11-05T16:49:53.431Z",
    "2020-11-05T18:32:08.054Z",
    "2020-11-05T19:00:31.633Z",
    "2020-11-05T19:25:26.705Z",
    "2020-11-05T19:40:41.812Z",
    "2020-11-05T20:28:11.145Z",
    "2020-11-05T20:43:46.995Z",
    "2020-11-05T21:14:29.887Z",
    "2020-11-05T22:07:25.227Z",
    "2020-11-05T22:19:37.037Z",
    "2020-11-05T22:38:24.906Z",
    "2020-11-05T23:03:25.333Z",
    "2020-11-05T23:54:45.478Z",
    "2020-11-06T00:22:37.169Z",
    "2020-11-06T01:55:44.581Z",
    "2020-11-06T02:33:12.517Z",
    "2020-11-06T03:19:39.122Z",
    "2020-11-06T04:09:36.360Z",
    "2020-11-06T06:30:07.181Z",
    "2020-11-06T07:38:26.297Z",
    "2020-11-06T08:38:03.578Z",
    "2020-11-06T09:18:42.027Z",
    "2020-11-06T10:06:29.648Z",
    "2020-11-06T13:06:57.354Z",
    "2020-11-06T14:20:32.293Z",
    "2020-11-06T15:34:35.526Z",
    "2020-11-06T16:24:44.007Z",
    "2020-11-06T16:30:48.498Z",
    "2020-11-06T19:19:09.095Z",
    "2020-11-06T19:40:45.897Z",
    "2020-11-06T20:23:01.484Z",
    "2020-11-06T20:38:34.335Z",
    "2020-11-06T22:07:17.544Z",
    "2020-11-06T22:22:34.568Z",
    "2020-11-06T22:38:06.794Z",
    "2020-11-06T22:53:31.036Z",
    "2020-11-06T23:42:15.171Z",
    "2020-11-06T23:45:17.767Z",
    "2020-11-06T23:57:39.240Z",
    "2020-11-07T01:28:54.872Z",
    "2020-11-07T02:53:44.150Z",
    "2020-11-07T05:38:17.006Z",
    "2020-11-07T07:46:31.838Z",
    "2020-11-07T18:15:34.503Z",
    "2020-11-07T19:20:27.474Z",
    "2020-11-07T19:46:17.236Z",
    "2020-11-07T23:53:18.153Z",
    "2020-11-08T07:23:21.206Z",
    "2020-11-08T13:09:39.235Z",
    "2020-11-08T19:38:53.915Z",
    "2020-11-09T14:35:24.523Z",
    "2020-11-09T16:02:35.204Z",
    "2020-11-09T16:26:44.754Z",
    "2020-11-09T17:16:59.669Z",
    "2020-11-09T19:02:32.336Z",
    "2020-11-09T19:37:20.471Z",
    "2020-11-09T21:29:34.470Z",
    "2020-11-09T22:12:11.656Z",
    "2020-11-09T22:46:43.786Z",
    "2020-11-09T23:35:12.237Z",
    "2020-11-10T01:52:22.197Z",
    "2020-11-10T14:53:53.873Z",
    "2020-11-10T16:59:42.737Z",
    "2020-11-10T18:45:51.675Z",
    "2020-11-10T20:10:26.030Z",
    "2020-11-10T21:18:12.376Z",
    "2020-11-10T23:28:22.595Z",
    "2020-11-11T00:12:28.188Z",
    "2020-11-11T19:09:28.636Z",
    "2020-11-11T21:10:30.230Z",
    "2020-11-11T22:32:34.439Z",
    "latest"),
  HI = c(
    "latest"),
  KY = c(
    "latest"),
  LA = c(
    "latest"),
  MI = c(
    "2020-11-03T19:39:31.715Z",
    "2020-11-03T23:01:38.141Z",
    "2020-11-03T23:28:40.644Z",
    "2020-11-04T01:10:59.248Z",
    "2020-11-04T01:14:18.060Z",
    "2020-11-04T01:20:51.388Z",
    "2020-11-04T01:22:40.090Z",
    "2020-11-04T01:24:58.717Z",
    "2020-11-04T01:27:13.495Z",
    "2020-11-04T01:29:29.542Z",
    "2020-11-04T01:31:49.959Z",
    "2020-11-04T01:33:27.422Z",
    "2020-11-04T01:36:26.208Z",
    "2020-11-04T01:38:03.265Z",
    "2020-11-04T01:39:24.329Z",
    "2020-11-04T01:50:31.590Z",
    "2020-11-04T01:52:08.129Z",
    "2020-11-04T01:53:58.846Z",
    "2020-11-04T01:56:48.674Z",
    "2020-11-04T01:58:36.648Z",
    "2020-11-04T02:00:53.066Z",
    "2020-11-04T02:02:28.825Z",
    "2020-11-04T02:04:20.324Z",
    "2020-11-04T02:09:03.824Z",
    "2020-11-04T02:11:13.052Z",
    "2020-11-04T02:15:28.789Z",
    "2020-11-04T02:17:48.861Z",
    "2020-11-04T02:22:17.499Z",
    "2020-11-04T02:23:19.290Z",
    "2020-11-04T02:31:05.574Z",
    "2020-11-04T02:38:12.232Z",
    "2020-11-04T02:41:59.405Z",
    "2020-11-04T02:44:15.426Z",
    "2020-11-04T02:48:45.922Z",
    "2020-11-04T02:52:41.280Z",
    "2020-11-04T02:57:10.828Z",
    "2020-11-04T03:08:03.508Z",
    "2020-11-04T03:10:17.901Z",
    "2020-11-04T03:14:50.460Z",
    "2020-11-04T03:21:00.872Z",
    "2020-11-04T03:23:13.917Z",
    "2020-11-04T03:25:32.264Z",
    "2020-11-04T03:27:59.641Z",
    "2020-11-04T03:30:05.652Z",
    "2020-11-04T03:32:30.705Z",
    "2020-11-04T03:35:24.646Z",
    "2020-11-04T03:36:31.024Z",
    "2020-11-04T03:38:46.540Z",
    "2020-11-04T03:49:43.478Z",
    "2020-11-04T03:53:58.866Z",
    "2020-11-04T03:58:31.489Z",
    "2020-11-04T04:02:52.090Z",
    "2020-11-04T04:07:12.222Z",
    "2020-11-04T04:15:34.564Z",
    "2020-11-04T04:17:44.730Z",
    "2020-11-04T04:20:05.116Z",
    "2020-11-04T04:21:08.767Z",
    "2020-11-04T04:23:04.729Z",
    "2020-11-04T04:25:16.599Z",
    "2020-11-04T04:32:00.482Z",
    "2020-11-04T04:37:49.340Z",
    "2020-11-04T04:40:28.181Z",
    "2020-11-04T04:46:52.403Z",
    "2020-11-04T04:53:19.187Z",
    "2020-11-04T04:57:50.994Z",
    "2020-11-04T05:04:21.379Z",
    "2020-11-04T05:27:48.316Z",
    "2020-11-04T05:34:18.745Z",
    "2020-11-04T05:36:29.666Z",
    "2020-11-04T05:47:22.518Z",
    "2020-11-04T06:07:07.739Z",
    "2020-11-04T06:25:00.935Z",
    "2020-11-04T06:27:58.556Z",
    "2020-11-04T06:31:10.397Z",
    "2020-11-04T06:37:58.758Z",
    "2020-11-04T06:44:24.358Z",
    "2020-11-04T06:46:33.719Z",
    "2020-11-04T06:55:07.616Z",
    "2020-11-04T07:08:16.162Z",
    "2020-11-04T07:16:41.517Z",
    "2020-11-04T07:21:20.877Z",
    "2020-11-04T07:25:36.989Z",
    "2020-11-04T07:39:34.224Z",
    "2020-11-04T07:41:35.433Z",
    "2020-11-04T07:48:08.874Z",
    "2020-11-04T07:56:55.619Z",
    "2020-11-04T08:05:11.635Z",
    "2020-11-04T08:10:57.961Z",
    "2020-11-04T08:18:23.593Z",
    "2020-11-04T08:27:35.760Z",
    "2020-11-04T08:49:01.772Z",
    "2020-11-04T09:15:46.574Z",
    "2020-11-04T09:18:01.210Z",
    "2020-11-04T10:01:59.299Z",
    "2020-11-04T10:23:34.581Z",
    "2020-11-04T10:49:26.786Z",
    "2020-11-04T10:57:51.728Z",
    "2020-11-04T11:08:51.869Z",
    "2020-11-04T11:31:43.768Z",
    "2020-11-04T11:38:05.943Z",
    "2020-11-04T12:03:50.648Z",
    "2020-11-04T12:31:15.976Z",
    "2020-11-04T12:46:41.696Z",
    "2020-11-04T12:54:06.809Z",
    "2020-11-04T13:17:53.063Z",
    "2020-11-04T13:40:32.460Z",
    "2020-11-04T14:07:24.703Z",
    "2020-11-04T14:16:03.886Z",
    "2020-11-04T14:46:30.247Z",
    "2020-11-04T15:12:44.730Z",
    "2020-11-04T15:35:33.018Z",
    "2020-11-04T15:45:39.037Z",
    "2020-11-04T15:57:59.521Z",
    "2020-11-04T16:22:59.957Z",
    "2020-11-04T16:52:37.111Z",
    "2020-11-04T17:21:23.574Z",
    "2020-11-04T17:39:06.402Z",
    "2020-11-04T17:48:12.582Z",
    "2020-11-04T19:10:10.447Z",
    "2020-11-04T20:10:53.927Z",
    "2020-11-04T20:38:47.570Z",
    "2020-11-04T22:40:38.521Z",
    "2020-11-05T00:06:27.381Z",
    "2020-11-05T01:45:11.832Z",
    "2020-11-05T03:08:50.581Z",
    "2020-11-05T16:03:39.888Z",
    "2020-11-05T19:20:10.316Z",
    "2020-11-05T20:52:37.622Z",
    "2020-11-06T04:05:37.579Z",
    "2020-11-06T13:29:24.875Z",
    "2020-11-06T18:26:43.677Z",
    "2020-11-06T19:26:49.796Z",
    "2020-11-06T21:27:28.703Z",
    "2020-11-06T23:27:08.887Z",
    "2020-11-09T18:11:26.548Z",
    "2020-11-10T15:30:00.413Z",
    "2020-11-10T19:13:08.066Z",
    "latest"),
  MN = c(
    "latest"),
  MT = c(
    "latest"),
  NE = c(
    "latest"),
  NM = c(
    "latest"),
  NC = c(
    "2020-10-30T13:19:01.425Z",
    "2020-11-04T01:20:19.239Z",
    "2020-11-04T01:23:38.338Z",
    "2020-11-04T01:26:39.096Z",
    "2020-11-04T01:29:41.091Z",
    "2020-11-04T01:31:08.724Z",
    "2020-11-04T01:35:38.862Z",
    "2020-11-04T01:37:10.165Z",
    "2020-11-04T01:40:36.437Z",
    "2020-11-04T01:48:06.839Z",
    "2020-11-04T01:52:41.754Z",
    "2020-11-04T01:56:16.878Z",
    "2020-11-04T01:58:05.743Z",
    "2020-11-04T02:01:03.418Z",
    "2020-11-04T02:05:22.683Z",
    "2020-11-04T02:11:18.353Z",
    "2020-11-04T02:14:20.101Z",
    "2020-11-04T02:20:04.007Z",
    "2020-11-04T02:23:01.319Z",
    "2020-11-04T02:31:51.080Z",
    "2020-11-04T02:37:39.227Z",
    "2020-11-04T02:42:13.811Z",
    "2020-11-04T02:46:05.114Z",
    "2020-11-04T02:49:24.573Z",
    "2020-11-04T02:50:50.460Z",
    "2020-11-04T02:56:37.691Z",
    "2020-11-04T02:59:30.934Z",
    "2020-11-04T03:05:13.969Z",
    "2020-11-04T03:09:38.288Z",
    "2020-11-04T03:15:33.198Z",
    "2020-11-04T03:18:24.693Z",
    "2020-11-04T03:21:20.686Z",
    "2020-11-04T03:24:21.544Z",
    "2020-11-04T03:28:46.452Z",
    "2020-11-04T03:31:43.800Z",
    "2020-11-04T03:34:41.706Z",
    "2020-11-04T03:38:56.453Z",
    "2020-11-04T03:49:04.336Z",
    "2020-11-04T03:52:05.984Z",
    "2020-11-04T03:57:46.736Z",
    "2020-11-04T04:05:00.748Z",
    "2020-11-04T04:12:05.116Z",
    "2020-11-04T04:17:57.163Z",
    "2020-11-04T04:20:35.992Z",
    "2020-11-04T04:23:49.913Z",
    "2020-11-04T04:25:14.743Z",
    "2020-11-04T04:31:27.675Z",
    "2020-11-04T05:05:47.821Z",
    "2020-11-04T05:35:13.886Z",
    "2020-11-04T15:04:03.994Z",
    "2020-11-04T16:31:43.206Z",
    "2020-11-06T21:47:49.680Z",
    "2020-11-06T23:00:00.860Z",
    "2020-11-06T23:24:08.550Z",
    "2020-11-07T01:35:55.396Z",
    "2020-11-07T19:32:53.808Z",
    "2020-11-07T23:48:22.906Z",
    "2020-11-09T13:51:05.275Z",
    "2020-11-09T17:07:00.683Z",
    "2020-11-09T18:33:02.085Z",
    "2020-11-09T20:11:36.565Z",
    "2020-11-09T21:53:37.914Z",
    "2020-11-09T22:41:53.590Z",
    "2020-11-09T23:47:46.461Z",
    "2020-11-10T01:27:09.630Z",
    "2020-11-10T12:06:50.104Z",
    "2020-11-10T15:08:54.317Z",
    "2020-11-10T16:49:48.417Z",
    "2020-11-10T21:40:22.345Z",
    "2020-11-10T21:43:53.067Z",
    "2020-11-10T23:33:55.796Z",
    "2020-11-11T02:49:14.995Z",
    "2020-11-11T16:30:55.800Z",
    "2020-11-11T21:21:55.407Z",
    "latest"),
  ND = c(
    "latest"),
  OK = c(
    "latest"),
  PA = c(
    "2020-11-03T19:39:48.428Z",
    "2020-11-03T19:47:21.689Z",
    "2020-11-04T01:02:56.961Z",
    "2020-11-04T01:11:32.237Z",
    "2020-11-04T01:15:49.757Z",
    "2020-11-04T01:16:22.794Z",
    "2020-11-04T01:20:49.779Z",
    "2020-11-04T01:31:00.020Z",
    "2020-11-04T01:37:59.697Z",
    "2020-11-04T01:41:00.339Z",
    "2020-11-04T01:47:45.735Z",
    "2020-11-04T01:51:32.742Z",
    "2020-11-04T01:56:46.621Z",
    "2020-11-04T01:58:03.337Z",
    "2020-11-04T02:02:27.783Z",
    "2020-11-04T02:07:46.029Z",
    "2020-11-04T02:12:30.122Z",
    "2020-11-04T02:16:40.084Z",
    "2020-11-04T02:21:55.078Z",
    "2020-11-04T02:22:26.699Z",
    "2020-11-04T02:23:43.894Z",
    "2020-11-04T02:33:08.991Z",
    "2020-11-04T02:37:37.129Z",
    "2020-11-04T02:41:48.141Z",
    "2020-11-04T02:43:32.758Z",
    "2020-11-04T02:46:36.465Z",
    "2020-11-04T02:48:21.416Z",
    "2020-11-04T02:52:59.942Z",
    "2020-11-04T02:57:03.104Z",
    "2020-11-04T02:58:51.687Z",
    "2020-11-04T03:01:12.045Z",
    "2020-11-04T03:08:04.508Z",
    "2020-11-04T03:11:50.154Z",
    "2020-11-04T03:16:43.281Z",
    "2020-11-04T03:17:45.684Z",
    "2020-11-04T03:23:32.564Z",
    "2020-11-04T03:25:36.542Z",
    "2020-11-04T03:28:32.423Z",
    "2020-11-04T03:30:10.090Z",
    "2020-11-04T03:32:07.052Z",
    "2020-11-04T03:32:40.564Z",
    "2020-11-04T03:36:46.369Z",
    "2020-11-04T03:39:45.667Z",
    "2020-11-04T03:47:34.224Z",
    "2020-11-04T03:51:55.726Z",
    "2020-11-04T03:58:36.379Z",
    "2020-11-04T04:00:31.893Z",
    "2020-11-04T04:02:32.548Z",
    "2020-11-04T04:07:12.226Z",
    "2020-11-04T04:11:09.936Z",
    "2020-11-04T04:17:19.111Z",
    "2020-11-04T04:19:38.017Z",
    "2020-11-04T04:21:05.336Z",
    "2020-11-04T04:24:42.825Z",
    "2020-11-04T04:31:58.444Z",
    "2020-11-04T04:35:50.923Z",
    "2020-11-04T04:42:04.229Z",
    "2020-11-04T04:51:15.817Z",
    "2020-11-04T04:57:54.465Z",
    "2020-11-04T05:01:47.468Z",
    "2020-11-04T05:27:31.945Z",
    "2020-11-04T05:32:10.701Z",
    "2020-11-04T05:36:29.115Z",
    "2020-11-04T05:47:38.056Z",
    "2020-11-04T06:04:43.127Z",
    "2020-11-04T06:22:32.255Z",
    "2020-11-04T06:29:19.959Z",
    "2020-11-04T06:31:07.427Z",
    "2020-11-04T06:42:15.150Z",
    "2020-11-04T06:46:11.076Z",
    "2020-11-04T07:08:18.041Z",
    "2020-11-04T07:12:42.570Z",
    "2020-11-04T07:21:12.617Z",
    "2020-11-04T07:37:18.545Z",
    "2020-11-04T07:43:45.178Z",
    "2020-11-04T08:02:03.378Z",
    "2020-11-04T08:16:20.848Z",
    "2020-11-04T08:31:05.033Z",
    "2020-11-04T09:06:53.895Z",
    "2020-11-04T09:39:44.457Z",
    "2020-11-04T10:25:19.444Z",
    "2020-11-04T11:42:30.769Z",
    "2020-11-04T12:26:42.051Z",
    "2020-11-04T13:08:49.766Z",
    "2020-11-04T14:09:35.941Z",
    "2020-11-04T14:16:04.731Z",
    "2020-11-04T14:27:12.269Z",
    "2020-11-04T15:00:33.289Z",
    "2020-11-04T15:11:18.797Z",
    "2020-11-04T15:47:05.771Z",
    "2020-11-04T16:01:46.071Z",
    "2020-11-04T16:09:34.002Z",
    "2020-11-04T16:46:06.879Z",
    "2020-11-04T16:51:34.329Z",
    "2020-11-04T16:57:01.192Z",
    "2020-11-04T17:21:28.840Z",
    "2020-11-04T17:33:56.364Z",
    "2020-11-04T17:42:07.729Z",
    "2020-11-04T17:48:47.507Z",
    "2020-11-04T18:27:17.837Z",
    "2020-11-04T18:36:12.904Z",
    "2020-11-04T19:06:04.118Z",
    "2020-11-04T19:30:12.818Z",
    "2020-11-04T19:36:36.312Z",
    "2020-11-04T19:42:53.456Z",
    "2020-11-04T19:47:16.038Z",
    "2020-11-04T20:02:30.249Z",
    "2020-11-04T20:11:11.777Z",
    "2020-11-04T20:19:51.752Z",
    "2020-11-04T20:36:57.750Z",
    "2020-11-04T20:41:12.386Z",
    "2020-11-04T20:47:22.963Z",
    "2020-11-04T21:02:00.193Z",
    "2020-11-04T21:20:48.387Z",
    "2020-11-04T21:30:53.607Z",
    "2020-11-04T21:40:39.685Z",
    "2020-11-04T21:45:43.648Z",
    "2020-11-04T22:14:46.373Z",
    "2020-11-04T22:21:36.531Z",
    "2020-11-04T23:01:09.186Z",
    "2020-11-04T23:16:00.304Z",
    "2020-11-04T23:46:45.510Z",
    "2020-11-04T23:50:41.482Z",
    "2020-11-05T00:16:15.690Z",
    "2020-11-05T01:03:58.062Z",
    "2020-11-05T01:22:08.485Z",
    "2020-11-05T02:07:51.083Z",
    "2020-11-05T02:37:24.295Z",
    "2020-11-05T03:16:38.965Z",
    "2020-11-05T03:21:08.291Z",
    "2020-11-05T04:01:20.730Z",
    "2020-11-05T06:01:05.838Z",
    "2020-11-05T14:01:50.971Z",
    "2020-11-05T14:20:34.146Z",
    "2020-11-05T14:40:36.884Z",
    "2020-11-05T15:11:13.143Z",
    "2020-11-05T16:53:45.563Z",
    "2020-11-05T18:42:02.059Z",
    "2020-11-05T19:11:17.978Z",
    "2020-11-05T19:31:02.217Z",
    "2020-11-05T20:01:39.880Z",
    "2020-11-05T20:22:19.687Z",
    "2020-11-05T20:50:25.026Z",
    "2020-11-05T21:06:26.014Z",
    "2020-11-05T21:45:48.474Z",
    "2020-11-05T22:11:15.693Z",
    "2020-11-05T22:46:36.477Z",
    "2020-11-05T23:18:35.972Z",
    "2020-11-05T23:56:33.767Z",
    "2020-11-06T00:46:21.725Z",
    "2020-11-06T01:19:47.638Z",
    "2020-11-06T01:32:14.168Z",
    "2020-11-06T01:50:34.550Z",
    "2020-11-06T02:11:31.520Z",
    "2020-11-06T02:21:31.704Z",
    "2020-11-06T02:35:52.691Z",
    "2020-11-06T03:16:21.224Z",
    "2020-11-06T04:31:05.425Z",
    "2020-11-06T06:22:25.319Z",
    "2020-11-06T07:39:29.874Z",
    "2020-11-06T10:27:52.923Z",
    "2020-11-06T13:35:45.935Z",
    "2020-11-06T13:48:29.269Z",
    "2020-11-06T14:11:15.160Z",
    "2020-11-06T15:38:36.840Z",
    "2020-11-06T16:26:51.267Z",
    "2020-11-06T19:10:53.677Z",
    "2020-11-06T20:15:38.653Z",
    "2020-11-06T20:30:49.849Z",
    "2020-11-06T22:01:06.237Z",
    "2020-11-06T22:26:01.785Z",
    "2020-11-06T22:36:05.403Z",
    "2020-11-06T23:41:21.474Z",
    "2020-11-06T23:51:43.357Z",
    "2020-11-07T01:56:04.188Z",
    "2020-11-07T03:01:22.232Z",
    "2020-11-07T03:46:12.440Z",
    "2020-11-07T10:07:26.578Z",
    "2020-11-07T14:56:50.997Z",
    "2020-11-07T16:35:54.408Z",
    "2020-11-07T16:41:11.130Z",
    "2020-11-07T19:10:27.892Z",
    "2020-11-07T20:50:18.177Z",
    "2020-11-07T21:25:49.074Z",
    "2020-11-07T22:52:02.482Z",
    "2020-11-07T23:06:36.960Z",
    "2020-11-08T00:17:56.017Z",
    "2020-11-08T04:34:00.719Z",
    "2020-11-08T06:10:53.434Z",
    "2020-11-08T15:52:00.876Z",
    "2020-11-08T21:06:10.082Z",
    "2020-11-08T22:49:03.807Z",
    "2020-11-09T03:23:36.199Z",
    "2020-11-09T14:45:53.028Z",
    "2020-11-09T15:51:34.108Z",
    "2020-11-09T16:31:43.216Z",
    "2020-11-09T17:11:11.335Z",
    "2020-11-09T18:56:27.420Z",
    "2020-11-09T19:31:31.903Z",
    "2020-11-09T21:31:25.014Z",
    "2020-11-09T21:35:31.553Z",
    "2020-11-09T22:44:59.607Z",
    "2020-11-09T23:44:13.151Z",
    "2020-11-10T00:22:30.984Z",
    "2020-11-10T06:03:21.729Z",
    "2020-11-10T14:57:39.075Z",
    "2020-11-10T16:18:07.613Z",
    "2020-11-10T18:52:23.461Z",
    "2020-11-10T20:13:12.724Z",
    "2020-11-10T21:30:56.943Z",
    "2020-11-10T21:45:52.979Z",
    "2020-11-10T23:31:18.839Z",
    "2020-11-11T00:16:54.249Z",
    "2020-11-11T03:01:18.012Z",
    "2020-11-11T03:16:00.804Z",
    "2020-11-11T20:31:19.396Z",
    "2020-11-11T21:50:46.218Z",
    "latest"),
  SC = c(
    "latest"),
  SD = c(
    "latest"),
  WA = c(
    "latest"),
  WV = c(
    "latest")
)

######################################################################################################

download.json <- function(base_dir, bool.download.last.only = FALSE)
{
  json_path <- paste0(base_dir,"/input/elections-assets/2020/data/precincts")
  for(iStateIndex in 1:length(arrStateAbbrs))
  {
    state_abbr <- arrStateAbbrs[iStateIndex]
    file_prefix <- list_file_prefixes[[state_abbr]]
    file_postfixes <- list_file_postfixes[[state_abbr]]
    
    iFirstTimestampFilePostfix <- ifelse(bool.download.last.only, length(file_postfixes), 1)
    for(iTimestampFilePostfix in iFirstTimestampFilePostfix:length(file_postfixes))
    {
      json_url <- paste0(url_template,"/",file_prefix,file_postfixes[iTimestampFilePostfix],file_extension)
      json_postfix_out <- file_postfixes[iTimestampFilePostfix]
      json_postfix_out <- gsub("T","_", json_postfix_out)
      json_postfix_out <- gsub("Z", "", json_postfix_out)
      json_postfix_out <- gsub("-","_", json_postfix_out)
      json_postfix_out <- gsub(":","_", json_postfix_out)
      json_postfix_out <- gsub(".","_", json_postfix_out, fixed = TRUE)
      json_path_name <- paste0(json_path,"/", gsub("-","_", file_prefix),json_postfix_out,file_extension)
      
      resp <- GET(json_url)
      if (status_code(resp) == 200)
      {
        print(paste0("Downloading JSON for ", file_prefix, " at ", file_postfixes[iTimestampFilePostfix]))
        res <- jsonlite::fromJSON(json_url)
        
        if(!dir.exists(json_path))
        {
          dir.create(json_path, recursive = T)
        }
        if(file.exists(json_path_name))
        {
          #backup_json_path_name <- paste0(json_path_name,".backup")
          #if(file.exists(backup_json_path_name))
          #{
          #  file.remove(backup_json_path_name)
          #}
          #file.rename(from = json_path_name, to = backup_json_path_name)
          file.remove(json_path_name)
        }
        jsonlite::write_json(res, path = json_path_name)
      } else
      {
        print(paste0("Skipping JSON for ", file_prefix, " at ", file_postfixes[iTimestampFilePostfix]))
      }
    }
  }
}

######################################################################################################

generate.county.csv <- function(base_dir, sid, state_abbr, file_prefix, file_postfixes)
{
  # Use primary key {locality_name, geo_id} and {uncounted_mail_ballots, votes} as the contents
  json_path <- paste0(base_dir,"/input/elections-assets/2020/data/precincts")
  csv_path <- paste0(base_dir,"/input/elections-assets/2020/data/precincts/csv")
  curr_cid <- 1
  ht_county_ids <- new.env()
  df_county_ids <- data.frame(
    sid         = numeric(),
    cid         = numeric(),
    county_name = character(), # aka "locality_name"
    county_fips = character(), # aka "geo_id"
    #uncounted_mail_ballots = double(),
    #votes                  = double(),
    stringsAsFactors       = FALSE) 
  df_choices <- data.frame(
    choice_name   = character(),
    choice_weight = numeric(),
    stringsAsFactors = FALSE)
  for(iTimestampFilePostfix in 1:length(file_postfixes))
  {
    json_postfix_out <- file_postfixes[iTimestampFilePostfix]
    json_postfix_out <- gsub("T","_", json_postfix_out)
    json_postfix_out <- gsub("Z", "", json_postfix_out)
    json_postfix_out <- gsub("-","_", json_postfix_out)
    json_postfix_out <- gsub(":","_", json_postfix_out)
    json_postfix_out <- gsub(".","_", json_postfix_out, fixed = TRUE)
    json_path_name <- paste0(json_path,"/", gsub("-","_", file_prefix),json_postfix_out,file_extension)

    print(paste0("Generating County CSV for ", state_abbr, " at ", json_postfix_out))
    res <- jsonlite::read_json(path = json_path_name)
  
    if(length(res$county_totals) > 0)
    {
      for(iCountyTotals in 1:length(res$county_totals))
      {
        # Use primary key {locality_name, geo_id} and {uncounted_mail_ballots, votes} as the contents
        #
        #res$county_totals[[iCountyTotals]]$locality_name               # "VENANGO"
        #res$county_totals[[iCountyTotals]]$precinct_id                 # "COUNTY"
        #res$county_totals[[iCountyTotals]]$vote_type                   # "total"
        #res$county_totals[[iCountyTotals]]$results                     # list()
        #res$county_totals[[iCountyTotals]]$uncounted_mail_ballots      # 19
        #res$county_totals[[iCountyTotals]]$geo_id                      # "42121"
        #res$county_totals[[iCountyTotals]]$precinct_name               # ""
        #res$county_totals[[iCountyTotals]]$locality_fips               # "42121"
        #res$county_totals[[iCountyTotals]]$is_geographic               # false
        #res$county_totals[[iCountyTotals]]$votes                       # 0
        #res$county_totals[[iCountyTotals]]$is_reporting                # false
        #
        new_choices <- names(res$county_totals[[iCountyTotals]]$results)
        missing_choices_names <- new_choices[!(new_choices %in% df_choices$choice_name)]
        if(length(missing_choices_names) > 0)
        {
          for(choice_name in missing_choices_names)
          {
            df_choices_row <- data.frame(
              choice_name   = character(1),
              choice_weight = numeric(1),
              stringsAsFactors = FALSE)
            df_choices_row$choice_name <- choice_name
            df_choices_row$choice_weight <- 0
            df_choices <- rbind(df_choices,df_choices_row)
          }
        }
        #
        locality_name <- toupper(res$county_totals[[iCountyTotals]]$locality_name)
        if(!exists(locality_name, envir = ht_county_ids, inherits = FALSE))
        {
          ht_county_ids[[locality_name]] <- curr_cid
          df_county_ids_row <- data.frame(
            sid         = numeric(1),
            cid         = numeric(1),
            county_name = character(1), # aka "locality_name"
            county_fips = character(1), # aka "geo_id" 
            stringsAsFactors       = FALSE)
          df_county_ids_row$sid[1]         <- sid
          df_county_ids_row$cid[1]         <- curr_cid
          df_county_ids_row$county_name[1] <- locality_name
          df_county_ids_row$county_fips[1] <- res$county_totals[[iCountyTotals]]$geo_id
          df_county_ids <- rbind(df_county_ids, df_county_ids_row)
          curr_cid <- curr_cid + 1
        } # END if(!exists(locality_name, envir = ht_county_ids, inherits = FALSE))
      } # END for(iCountyTotals in 1:length(res$county_totals))
    } # END if(length(res$county_totals) > 0)
  } # END for(iTimestampFilePostfix in 1:length(file_postfixes))
  df_county_ids <- df_county_ids[order(df_county_ids$county_name),]
  write.csv(x = df_county_ids, file = paste0(csv_path,"/",state_abbr,"_county",".csv"), row.names = FALSE)
  return (list(ht_county_ids = ht_county_ids, df_county_ids = df_county_ids, df_choices = df_choices))
}

generate.county.vote.type.csv <- function(base_dir, sid, state_abbr, file_prefix, file_postfixes,
                                          ht_county_ids, df_county_ids, df_choices)
{
  # Use primary key {locality_name, geo_id, vote_type} and {votes, bidenj, trumpd, jorgensenj} as the contents
  json_path <- paste0(base_dir,"/input/elections-assets/2020/data/precincts")
  csv_path <- paste0(base_dir,"/input/elections-assets/2020/data/precincts/csv")
  #
  curr_cid <- 1
  for(locality_name in names(ht_county_ids))
  {
    if(curr_cid < ht_county_ids[[locality_name]])
    {
      curr_cid <- ht_county_ids[[locality_name]]
    }
  }
  curr_cid <- curr_cid + 1
  #
  curr_vid <- 1
  ht_vote_type_ids <- new.env()
  df_vote_type_ids <- data.frame(
    sid                    = numeric(),
    vid                    = numeric(),
    vote_type              = character(),
    stringsAsFactors       = FALSE) 
  ht_county_vote_type_ids <- new.env()
  ht_locality_name_vote_type_ids <- new.env()
  df_county_vote_type_ids <- data.frame(
    sid             = numeric(),
    cid             = numeric(),
    vid             = numeric(),
    county_name     = character(), # aka "locality_name"
    vote_type       = character(),
    county_fips     = character(), # aka "geo_id"
    #is_geographic  = logical(),
    #votes          = double(),
    #bidenj         = double(),
    #trumpd         = double(),
    #jorgensenj     = double(),
    stringsAsFactors = FALSE) 
  for(iTimestampFilePostfix in 1:length(file_postfixes))
  {
    json_postfix_out <- file_postfixes[iTimestampFilePostfix]
    json_postfix_out <- gsub("T","_", json_postfix_out)
    json_postfix_out <- gsub("Z", "", json_postfix_out)
    json_postfix_out <- gsub("-","_", json_postfix_out)
    json_postfix_out <- gsub(":","_", json_postfix_out)
    json_postfix_out <- gsub(".","_", json_postfix_out, fixed = TRUE)
    json_path_name <- paste0(json_path,"/", gsub("-","_", file_prefix),json_postfix_out,file_extension)

    print(paste0("Generating County by Vote Type CSV for ", state_abbr, " at ", json_postfix_out))
    res <- jsonlite::read_json(path = json_path_name)
    if(length(res$county_by_vote_type) > 0)
    {
      for(iCountyByVoteType in 1:length(res$county_by_vote_type))
      {
        # Use primary key {locality_name, geo_id, vote_type} and {votes, bidenj, trumpd, jorgensenj} as the contents
        #
        #res$county_by_vote_type[[iCountyByVoteType]]$precinct_id         # "COUNTY"
        #res$county_by_vote_type[[iCountyByVoteType]]$locality_name       # "ARMSTRONG"
        #res$county_by_vote_type[[iCountyByVoteType]]$results$bidenj      # 0
        #res$county_by_vote_type[[iCountyByVoteType]]$results$trumpd      # 0
        #res$county_by_vote_type[[iCountyByVoteType]]$results$jorgensenj  # 0
        #res$county_by_vote_type[[iCountyByVoteType]]$vote_type           # "provisional"
        #res$county_by_vote_type[[iCountyByVoteType]]$geo_id              # "42005"
        #res$county_by_vote_type[[iCountyByVoteType]]$precinct_name       # ""
        #res$county_by_vote_type[[iCountyByVoteType]]$locality_fips       # "42005"
        #res$county_by_vote_type[[iCountyByVoteType]]$is_geographic       # false
        #res$county_by_vote_type[[iCountyByVoteType]]$votes               # 0
        #res$county_by_vote_type[[iCountyByVoteType]]$is_reporting        # false
        #
        new_choices <- names(res$county_by_vote_type[[iCountyByVoteType]]$results)
        missing_choices_names <- new_choices[!(new_choices %in% df_choices$choice_name)]
        if(length(missing_choices_names) > 0)
        {
          for(choice_name in missing_choices_names)
          {
            df_choices_row <- data.frame(
              choice_name   = character(1),
              choice_weight = numeric(1),
              stringsAsFactors = FALSE)
            df_choices_row$choice_name <- choice_name
            df_choices_row$choice_weight <- 0
            df_choices <- rbind(df_choices,df_choices_row)
          }
        }
        #
        locality_name <- toupper(res$county_by_vote_type[[iCountyByVoteType]]$locality_name)
        vote_type <- res$county_by_vote_type[[iCountyByVoteType]]$vote_type
        locality_name__vote_type <- paste0(locality_name, "|", vote_type)
        #
        if(!exists(locality_name, envir = ht_county_ids, inherits = FALSE))
        {
          ht_county_ids[[locality_name]] <- curr_cid
          df_county_ids_row <- data.frame(
            sid              = numeric(1),
            cid              = numeric(1),
            county_name      = character(1),
            county_fips      = character(1),
            stringsAsFactors = FALSE)
          df_county_ids_row$sid[1]         <- sid
          df_county_ids_row$cid[1]         <- curr_cid
          df_county_ids_row$county_name[1] <- locality_name
          df_county_ids_row$county_fips[1] <- res$county_by_vote_type[[iCountyTotals]]$geo_id
          df_county_ids <- rbind(df_county_ids, df_county_ids_row)
          curr_cid <- curr_cid + 1
          # warning("Found new county ID at the second stage.")
        }
        #
        if(!exists(vote_type, envir = ht_vote_type_ids, inherits = FALSE))
        {
          ht_vote_type_ids[[vote_type]] <- curr_vid
          df_vote_type_ids_row <- data.frame(
            sid                    = numeric(1),
            vid                    = numeric(1),
            vote_type              = character(1),
            stringsAsFactors       = FALSE) 
          df_vote_type_ids_row$sid       <- sid
          df_vote_type_ids_row$vid       <- curr_vid
          df_vote_type_ids_row$vote_type <- res$county_by_vote_type[[iCountyByVoteType]]$vote_type
          df_vote_type_ids <- rbind(df_vote_type_ids, df_vote_type_ids_row)
          curr_vid <- curr_vid + 1
        }
        #
        if(!exists(locality_name__vote_type, envir = ht_locality_name_vote_type_ids, inherits = FALSE))
        {
          ht_locality_name_vote_type_ids[[locality_name__vote_type]] <- 1
          df_county_vote_type_ids_row <- data.frame(
            sid              = numeric(1),
            cid              = numeric(1),
            vid              = numeric(1),
            county_name      = character(1), # aka "locality_name"
            vote_type        = character(1),
            county_fips      = character(1), # aka "geo_id"
            stringsAsFactors = FALSE)
          #
          df_county_vote_type_ids_row$sid[1]         <- sid
          df_county_vote_type_ids_row$cid[1]         <- ht_county_ids[[locality_name]]
          df_county_vote_type_ids_row$vid[1]         <- ht_vote_type_ids[[vote_type]]
          df_county_vote_type_ids_row$county_name[1] <- locality_name
          df_county_vote_type_ids_row$vote_type[1]   <- res$county_by_vote_type[[iCountyByVoteType]]$vote_type
          df_county_vote_type_ids_row$county_fips[1] <- res$county_by_vote_type[[iCountyByVoteType]]$geo_id
          #
          df_county_vote_type_ids <- rbind(df_county_vote_type_ids, df_county_vote_type_ids_row)
        } # END if(!exists(locality_name__vote_type, envir = ht_vote_type_ids, inherits = FALSE))
      } # END for(iCountyByVoteType in 1:length(res$county_by_vote_type))
    } # END if(length(res$county_by_vote_type) > 0)
  } # END for(iTimestampFilePostfix in 1:length(file_postfixes))
  #
  df_vote_type_ids <- df_vote_type_ids[order(df_vote_type_ids$vote_type),]
  df_county_ids <- df_county_ids[order(df_county_ids$county_name),]
  df_county_vote_type_ids <- df_county_vote_type_ids[order(df_county_vote_type_ids$county_name,
                                                           df_county_vote_type_ids$vote_type),]
  #
  write.csv(x = df_vote_type_ids, file = paste0(csv_path,"/",state_abbr,"_vote_type",".csv"), row.names = FALSE)
  write.csv(x = df_county_ids, file = paste0(csv_path,"/",state_abbr,"_county",".csv"), row.names = FALSE)
  write.csv(x = df_county_vote_type_ids, file = paste0(csv_path,"/",state_abbr,"_county_vote_type",".csv"), row.names = FALSE)
  #
  return (list(ht_county_ids = ht_county_ids, df_county_ids = df_county_ids,
               ht_vote_type_ids = ht_vote_type_ids, df_vote_type_ids = df_vote_type_ids,
               df_choices = df_choices))
}

generate.precinct.csv <- function(base_dir, sid, state_abbr, file_prefix, file_postfixes,
                                  ht_county_ids, df_county_ids, df_choices)
{
  # Use primary key {locality_name, precinct_id} and {votes, bidenj, trumpd, jorgensenj, other} as the contents
  json_path <- paste0(base_dir,"/input/elections-assets/2020/data/precincts")
  csv_path <- paste0(base_dir,"/input/elections-assets/2020/data/precincts/csv")
  curr_pid <- 1
  ht_precinct_ids <- new.env()
  df_precinct_ids <- data.frame(
    sid              = numeric(),
    cid              = numeric(),
    pid              = numeric(),
    county_name      = character(), # aka "locality_name"
    precinct_id      = character(),
    county_fips      = character(), # aka "locality_fips"
    precinct_geo_id  = character(), # aka "geo_id"
    precinct_name    = character(),
    #is_geographic   = logical(),
    #is_reporting    = logical(),
    #votes           = double(),
    #bidenj          = double(),
    #trumpd          = double(),
    #jorgensenj      = double(),
    #other           = double(),
    stringsAsFactors = FALSE) 
  for(iTimestampFilePostfix in 1:length(file_postfixes))
  {
    json_postfix_out <- file_postfixes[iTimestampFilePostfix]
    json_postfix_out <- gsub("T","_", json_postfix_out)
    json_postfix_out <- gsub("Z", "", json_postfix_out)
    json_postfix_out <- gsub("-","_", json_postfix_out)
    json_postfix_out <- gsub(":","_", json_postfix_out)
    json_postfix_out <- gsub(".","_", json_postfix_out, fixed = TRUE)
    json_path_name <- paste0(json_path,"/", gsub("-","_", file_prefix),json_postfix_out,file_extension)
    
    print(paste0("Generating Precinct CSV for ", state_abbr, " at ", json_postfix_out))
    res <- jsonlite::read_json(path = json_path_name)

    if(length(res$precinct_totals) > 0)
    {
      for(iPrecinctTotals in 1:length(res$precinct_totals))
      {
        # Use primary key {locality_name, precinct_id} and {votes, bidenj, trumpd, jorgensenj, other} as the contents
        #
        #res$precinct_totals[[iPrecinctTotals]]$locality_name               # "Cambria"
        #res$precinct_totals[[iPrecinctTotals]]$precinct_id                 # "Allegheny Township Voting Precinct"
        #res$precinct_totals[[iPrecinctTotals]]$results$bidenj              # 205
        #res$precinct_totals[[iPrecinctTotals]]$results$trumpd              # 779
        #res$precinct_totals[[iPrecinctTotals]]$results$jorgensenj          # 7
        #res$precinct_totals[[iPrecinctTotals]]$results$other               # 1
        #res$precinct_totals[[iPrecinctTotals]]$vote_type                   # "total"
        #res$precinct_totals[[iPrecinctTotals]]$geo_id                      # "42021-ALLEGHENY TWP"
        #res$precinct_totals[[iPrecinctTotals]]$precinct_name               # "ALLEGHENY TWP"
        #res$precinct_totals[[iPrecinctTotals]]$locality_fips               # "42021"
        #res$precinct_totals[[iPrecinctTotals]]$is_geographic               # true
        #res$precinct_totals[[iPrecinctTotals]]$votes                       # 992
        #res$precinct_totals[[iPrecinctTotals]]$is_reporting                # true
        #
        new_choices <- names(res$precinct_totals[[iPrecinctTotals]]$results)
        missing_choices_names <- new_choices[!(new_choices %in% df_choices$choice_name)]
        if(length(missing_choices_names) > 0)
        {
          for(choice_name in missing_choices_names)
          {
            df_choices_row <- data.frame(
              choice_name   = character(1),
              choice_weight = numeric(1),
              stringsAsFactors = FALSE)
            df_choices_row$choice_name <- choice_name
            df_choices_row$choice_weight <- 0
            df_choices <- rbind(df_choices,df_choices_row)
          }
        }
        #
        locality_name <- toupper(res$precinct_totals[[iPrecinctTotals]]$locality_name)
        locality_name__precinct_id <- paste0(locality_name, "|", res$precinct_totals[[iPrecinctTotals]]$precinct_id)
        if(!exists(locality_name__precinct_id, envir = ht_precinct_ids, inherits = FALSE))
        {
          ht_precinct_ids[[locality_name__precinct_id]] <- curr_pid
          df_precinct_ids_row <- data.frame(
            sid              = numeric(1),
            cid              = numeric(1),
            pid              = numeric(1),
            county_name      = character(1),
            precinct_id      = character(1),
            county_fips      = character(1),
            precinct_geo_id  = character(1),
            precinct_name    = character(1),
            stringsAsFactors = FALSE)
          df_precinct_ids_row$sid[1]             <- sid
          df_precinct_ids_row$cid[1]             <- ht_county_ids[[locality_name]]
          df_precinct_ids_row$pid[1]             <- curr_pid
          df_precinct_ids_row$county_name[1]     <- locality_name
          df_precinct_ids_row$precinct_id[1]     <- res$precinct_totals[[iPrecinctTotals]]$precinct_id
          df_precinct_ids_row$county_fips[1]     <- res$precinct_totals[[iPrecinctTotals]]$locality_fips
          df_precinct_ids_row$precinct_geo_id[1] <- res$precinct_totals[[iPrecinctTotals]]$geo_id
          df_precinct_ids_row$precinct_name[1]   <- res$precinct_totals[[iPrecinctTotals]]$precinct_name

          df_precinct_ids <- rbind(df_precinct_ids, df_precinct_ids_row)
          curr_pid <- curr_pid + 1
        } # END if(!exists(locality_name__precinct_id, envir = ht_precinct_ids, inherits = FALSE))
      } # END for(iPrecinctTotals in 1:length(res$precinct_totals))
    } # END if(length(res$precinct_totals) > 0)
  } # END for(iTimestampFilePostfix in 1:length(file_postfixes))
  df_precinct_ids <- df_precinct_ids[order(df_precinct_ids$county_name, df_precinct_ids$precinct_id),]
  write.csv(x = df_precinct_ids, file = paste0(csv_path,"/",state_abbr,"_precinct",".csv"), row.names = FALSE)
  lst_precinct_ids <- list(ht_county_ids = ht_county_ids, df_county_ids = df_county_ids,
                           ht_precinct_ids = ht_precinct_ids, df_precinct_ids = df_precinct_ids,
                           df_choices = df_choices)
  return(lst_precinct_ids)
}

generate.precinct.vote.type.csv <- function(base_dir, sid, state_abbr, file_prefix, file_postfixes,
                                            ht_county_ids, df_county_ids,
                                            ht_precinct_ids, df_precinct_ids,
                                            ht_vote_type_ids, df_vote_type_ids,
                                            df_choices)
{
  # Use primary key {locality_name, precinct_id, vote_type} and {votes, bidenj, trumpd, jorgensenj, other} as the contents
  json_path <- paste0(base_dir,"/input/elections-assets/2020/data/precincts")
  csv_path <- paste0(base_dir,"/input/elections-assets/2020/data/precincts/csv")
  curr_cid <- 1
  for(locality_name in names(ht_county_ids))
  {
    if(curr_cid < ht_county_ids[[locality_name]])
    {
      curr_cid <- ht_county_ids[[locality_name]]
    }
  }
  curr_cid <- curr_cid + 1
  #
  curr_pid <- 1
  for(locality_name__precinct_id in names(ht_precinct_ids))
  {
    if(curr_pid < ht_precinct_ids[[locality_name__precinct_id]])
    {
      curr_pid <- ht_precinct_ids[[locality_name__precinct_id]]
    }
  }
  curr_pid <- curr_pid + 1
  #
  curr_vid <- 1
  for(vote_type_id in names(ht_vote_type_ids))
  {
    if(curr_vid < ht_vote_type_ids[[vote_type_id]])
    {
      curr_vid <- ht_vote_type_ids[[vote_type_id]]
    }
  }
  curr_vid <- curr_vid + 1
  #
  ht_locality_name_precinct_id_vote_type_ids <- new.env()
  df_precinct_vote_type_ids <- data.frame(
    sid              = numeric(),
    cid              = numeric(),
    pid              = numeric(),
    vid              = numeric(),
    county_name      = character(), # aka "locality_name"
    precinct_id      = character(),
    vote_type        = character(),
    county_fips      = character(), # aka "locality_fips"
    precinct_geo_id  = character(), # aka "geo_id"
    precinct_name    = character(),
    #is_geographic   = logical(),
    #votes           = double(),
    #bidenj          = double(),
    #trumpd          = double(),
    #jorgensenj      = double(),
    stringsAsFactors = FALSE) 
  time_origin_ms <- .Machine$double.xmax
  for(iTimestampFilePostfix in 1:length(file_postfixes))
  {
    str_snapshot_timestamp <- file_postfixes[iTimestampFilePostfix] # e.g. "2020-11-03T23:40:53.084Z" or 1604475653084
    if(str_snapshot_timestamp != "latest")
    {
      num_snapshot_timestamp_ms <- round(as.numeric(strptime(str_snapshot_timestamp, "%Y-%m-%dT%H:%M:%OSZ"))*1000.0) # + 0.001
    } else
    {
      num_snapshot_timestamp_ms <- round(as.numeric(strptime(str_latest_snapshot_timestamp, "%Y-%m-%dT%H:%M:%OSZ"))*1000.0) # + 0.001
    }
    time_origin_ms <- ifelse(num_snapshot_timestamp_ms < time_origin_ms, num_snapshot_timestamp_ms, time_origin_ms)
    #
    json_postfix_out <- file_postfixes[iTimestampFilePostfix]
    json_postfix_out <- gsub("T","_", json_postfix_out)
    json_postfix_out <- gsub("Z", "", json_postfix_out)
    json_postfix_out <- gsub("-","_", json_postfix_out)
    json_postfix_out <- gsub(":","_", json_postfix_out)
    json_postfix_out <- gsub(".","_", json_postfix_out, fixed = TRUE)
    json_path_name <- paste0(json_path,"/", gsub("-","_", file_prefix),json_postfix_out,file_extension)
    
    print(paste0("Generating Precinct by Vote Type CSV for ", state_abbr, " at ", json_postfix_out))
    res <- jsonlite::read_json(path = json_path_name)
    if(length(res$precinct_by_vote_type) > 0)
    {
      for(iPrecinctByVoteType in 1:length(res$precinct_by_vote_type))
      {
        # Use primary key {locality_name, geo_id, vote_type} and {votes, bidenj, trumpd, jorgensenj, other} as the contents
        #
        #res$precinct_by_vote_type[[iPrecinctByVoteType]]$precinct_id        # "ASPINWALL DIST 1"
        #res$precinct_by_vote_type[[iPrecinctByVoteType]]$locality_name      # "Allegheny"
        #res$precinct_by_vote_type[[iPrecinctByVoteType]]$is_reporting       # true
        #res$precinct_by_vote_type[[iPrecinctByVoteType]]$results$bidenj     # 105
        #res$precinct_by_vote_type[[iPrecinctByVoteType]]$results$trumpd     # 13
        #res$precinct_by_vote_type[[iPrecinctByVoteType]]$results$jorgensenj # 2
        #res$precinct_by_vote_type[[iPrecinctByVoteType]]$results$other      # 2
        #res$precinct_by_vote_type[[iPrecinctByVoteType]]$vote_type          # "absentee"
        #res$precinct_by_vote_type[[iPrecinctByVoteType]]$geo_id             # "42003-ASPINWALL 1"
        #res$precinct_by_vote_type[[iPrecinctByVoteType]]$precinct_name      # "ASPINWALL 1"
        #res$precinct_by_vote_type[[iPrecinctByVoteType]]$locality_fips      # "42003"
        #res$precinct_by_vote_type[[iPrecinctByVoteType]]$is_geographic      # true
        #res$precinct_by_vote_type[[iPrecinctByVoteType]]$votes              # 122
        #
        new_choices <- names(res$precinct_by_vote_type[[iPrecinctByVoteType]]$results)
        missing_choices_names <- new_choices[!(new_choices %in% df_choices$choice_name)]
        if(length(missing_choices_names) > 0)
        {
          for(choice_name in missing_choices_names)
          {
            df_choices_row <- data.frame(
              choice_name   = character(1),
              choice_weight = numeric(1),
              stringsAsFactors = FALSE)
            df_choices_row$choice_name <- choice_name
            df_choices_row$choice_weight <- 0
            df_choices <- rbind(df_choices,df_choices_row)
          }
        }
        if(iTimestampFilePostfix == length(file_postfixes))
        {
          for(choice_name in df_choices$choice_name)
          {
            if(choice_name %in% names(res$precinct_by_vote_type[[iPrecinctByVoteType]]$results))
            {
              df_choices$choice_weight[df_choices$choice_name == choice_name] <-
                df_choices$choice_weight[df_choices$choice_name == choice_name] +
                res$precinct_by_vote_type[[iPrecinctByVoteType]]$results[[choice_name]]
            }
          }
        }
        #
        locality_name <- toupper(res$precinct_by_vote_type[[iPrecinctByVoteType]]$locality_name)
        precinct_id <- res$precinct_by_vote_type[[iPrecinctByVoteType]]$precinct_id
        if("vote_type" %in% names(res$precinct_by_vote_type[[iPrecinctByVoteType]]))
        {
          vote_type <- res$precinct_by_vote_type[[iPrecinctByVoteType]]$vote_type
        } else
        {
          vote_type <- "unknown"
        }
        locality_name__precinct_id__vote_type <- paste0(locality_name, "|",
                                                        res$precinct_by_vote_type[[iPrecinctByVoteType]]$precinct_id, "|",
                                                        vote_type)
        locality_name__precinct_id <- paste0(locality_name, "|",
                                             res$precinct_by_vote_type[[iPrecinctByVoteType]]$precinct_id)
        if("locality_fips" %in% names(res$precinct_by_vote_type[[iPrecinctByVoteType]]))
        {
          locality_fips <- res$precinct_by_vote_type[[iPrecinctByVoteType]]$locality_fips
        } else
        {
          locality_fips <- ""
        }
        if("geo_id" %in% names(res$precinct_by_vote_type[[iPrecinctByVoteType]]))
        {
          geo_id <- res$precinct_by_vote_type[[iPrecinctByVoteType]]$geo_id
        } else
        {
          geo_id <- ""
        }
        if("precinct_name" %in% names(res$precinct_by_vote_type[[iPrecinctByVoteType]]))
        {
          precinct_name <- res$precinct_by_vote_type[[iPrecinctByVoteType]]$precinct_name
        } else
        {
          precinct_name <- ""
        }
        #
        if(!exists(vote_type, envir = ht_vote_type_ids, inherits = FALSE))
        {
          ht_vote_type_ids[[vote_type]] <- curr_vid
          df_vote_type_ids_row <- data.frame(
            sid                    = numeric(1),
            vid                    = numeric(1),
            vote_type              = character(1),
            stringsAsFactors       = FALSE) 
          df_vote_type_ids_row$sid       <- sid
          df_vote_type_ids_row$vid       <- curr_vid
          df_vote_type_ids_row$vote_type <- vote_type
          df_vote_type_ids <- rbind(df_vote_type_ids, df_vote_type_ids_row)
          curr_vid <- curr_vid + 1
          # warning("Found new vote type ID at the fourth stage.")
        }
        #
        if(!exists(locality_name, envir = ht_county_ids, inherits = FALSE))
        {
          ht_county_ids[[locality_name]] <- curr_cid
          df_county_ids_row <- data.frame(
            sid              = numeric(1),
            cid              = numeric(1),
            county_name      = character(1),
            county_fips      = character(1),
            stringsAsFactors = FALSE)
          df_county_ids_row$sid[1]         <- sid
          df_county_ids_row$cid[1]         <- curr_cid
          df_county_ids_row$county_name[1] <- locality_name
          df_county_ids_row$county_fips[1] <- geo_id
          df_county_ids <- rbind(df_county_ids, df_county_ids_row)
          curr_cid <- curr_cid + 1
          #warning("Found new county ID at the fourth stage.")
        }
        #
        if(!exists(locality_name__precinct_id, envir = ht_precinct_ids, inherits = FALSE))
        {
          ht_precinct_ids[[locality_name__precinct_id]] <- curr_pid
          df_precinct_ids_row <- data.frame(
            sid              = numeric(1),
            cid              = numeric(1),
            pid              = numeric(1),
            county_name      = character(1),
            precinct_id      = character(1),
            county_fips      = character(1),
            precinct_geo_id  = character(1),
            precinct_name    = character(1),
            stringsAsFactors = FALSE)
          df_precinct_ids_row$sid[1]             <- sid
          df_precinct_ids_row$cid[1]             <- ht_county_ids[[locality_name]]
          df_precinct_ids_row$pid[1]             <- curr_pid
          df_precinct_ids_row$county_name[1]     <- locality_name
          df_precinct_ids_row$precinct_id[1]     <- precinct_id
          df_precinct_ids_row$county_fips[1]     <- locality_fips
          df_precinct_ids_row$precinct_geo_id[1] <- geo_id
          df_precinct_ids_row$precinct_name[1]   <- precinct_name
          
          df_precinct_ids <- rbind(df_precinct_ids, df_precinct_ids_row)
          curr_pid <- curr_pid + 1
          # warning("Found new precinct ID at the fourth stage.")
        } # END if(!exists(locality_name__precinct_id, envir = ht_precinct_ids, inherits = FALSE))
        #
        if(!exists(locality_name__precinct_id__vote_type, envir = ht_locality_name_precinct_id_vote_type_ids, inherits = FALSE))
        {
          ht_locality_name_precinct_id_vote_type_ids[[locality_name__precinct_id__vote_type]] <- 1
          df_precinct_vote_type_ids_row <- data.frame(
            sid              = numeric(1),
            cid              = numeric(1),
            pid              = numeric(1),
            vid              = numeric(1),
            county_name      = character(1),
            precinct_id      = character(1),
            vote_type        = character(1),
            county_fips      = character(1),
            precinct_geo_id  = character(1),
            precinct_name    = character(1),
            stringsAsFactors = FALSE)
          #
          df_precinct_vote_type_ids_row$sid[1]             <- sid
          df_precinct_vote_type_ids_row$cid[1]             <- ht_county_ids[[locality_name]]
          df_precinct_vote_type_ids_row$pid[1]             <- ht_precinct_ids[[locality_name__precinct_id]]
          df_precinct_vote_type_ids_row$vid[1]             <- ht_vote_type_ids[[vote_type]]
          df_precinct_vote_type_ids_row$county_name[1]     <- locality_name
          df_precinct_vote_type_ids_row$precinct_id[1]     <- res$precinct_by_vote_type[[iPrecinctByVoteType]]$precinct_id
          df_precinct_vote_type_ids_row$vote_type[1]       <- vote_type
          df_precinct_vote_type_ids_row$county_fips[1]     <- locality_fips
          df_precinct_vote_type_ids_row$precinct_geo_id[1] <- geo_id
          df_precinct_vote_type_ids_row$precinct_name[1]   <- precinct_name
          #
          df_precinct_vote_type_ids <- rbind(df_precinct_vote_type_ids, df_precinct_vote_type_ids_row)
        } # END if(!exists(locality_name__precinct_id__vote_type, envir = ht_locality_name_precinct_id_vote_type_ids, inherits = FALSE))
      } # END for(iPrecinctByVoteType in 1:length(res$precinct_by_vote_type))
    } # END if(length(res$precinct_by_vote_type) > 0)
  } # END for(iTimestampFilePostfix in 1:length(file_postfixes))

  if(time_origin_ms == .Machine$double.xmax)
  {
    time_origin_ms <- round(as.numeric(strptime(str_latest_snapshot_timestamp, "%Y-%m-%dT%H:%M:%OSZ"))*1000.0) # + 0.001
  }
  
  #
  df_vote_type_ids <- df_vote_type_ids[order(df_vote_type_ids$vote_type),]
  df_county_ids <- df_county_ids[order(df_county_ids$county_name),]
  df_precinct_ids <- df_precinct_ids[order(df_precinct_ids$county_name,df_precinct_ids$precinct_id),]
  df_precinct_vote_type_ids <- df_precinct_vote_type_ids[order(df_precinct_vote_type_ids$county_name,
                                                               df_precinct_vote_type_ids$precinct_id,
                                                               df_precinct_vote_type_ids$vote_type),]
  df_choices <- df_choices[order(-df_choices$choice_weight),]
  #
  write.csv(x = df_vote_type_ids, file = paste0(csv_path,"/",state_abbr,"_vote_type",".csv"), row.names = FALSE)
  write.csv(x = df_county_ids, file = paste0(csv_path,"/",state_abbr,"_county",".csv"), row.names = FALSE)
  write.csv(x = df_precinct_ids, file = paste0(csv_path,"/",state_abbr,"_precinct",".csv"), row.names = FALSE)
  write.csv(x = df_precinct_vote_type_ids, file = paste0(csv_path,"/",state_abbr,"_precinct_vote_type",".csv"), row.names = FALSE)
  #
  return (list(ht_county_ids = ht_county_ids, df_county_ids = df_county_ids,
               ht_precinct_ids = ht_precinct_ids, df_precinct_ids = df_precinct_ids,
               ht_vote_type_ids = ht_vote_type_ids, df_vote_type_ids = df_vote_type_ids,
               time_origin_ms = time_origin_ms, df_choices = df_choices))
}

generate.precinct.csv2 <- function(base_dir, sid, state_abbr, file_prefix, file_postfixes)
{
  json_path <- paste0(base_dir,"/input/elections-assets/2020/data/precincts")
  csv_path <- paste0(base_dir,"/input/elections-assets/2020/data/precincts/csv")
  curr_cid <- 1
  curr_pid <- 1
  curr_vid <- 1
  #
  ht_vote_type_ids <- new.env()
  df_vote_type_ids <- data.frame(
    sid              = numeric(),
    vid              = numeric(),
    vote_type        = character(),
    stringsAsFactors = FALSE) 
  #
  ht_county_ids <- new.env()
  df_county_ids <- data.frame(
    sid              = numeric(),
    cid              = numeric(),
    county_name      = character(), # aka "locality_name"
    county_fips      = character(), # aka "locality_fips"
    stringsAsFactors = FALSE) 
  #
  ht_precinct_ids <- new.env()
  df_precinct_ids <- data.frame(
    sid              = numeric(),
    cid              = numeric(),
    pid              = numeric(),
    county_name      = character(), # aka "locality_name"
    precinct_id      = character(),
    county_fips      = character(), # aka "locality_fips"
    precinct_geo_id  = character(), # aka "geo_id"
    precinct_name    = character(),
    stringsAsFactors = FALSE) 
  #
  ht_county_vote_type_ids <- new.env()
  df_county_vote_type_ids <- data.frame(
    sid              = numeric(),
    cid              = numeric(),
    vid              = numeric(),
    county_name      = character(), # aka "locality_name"
    vote_type        = character(),
    county_fips      = character(), # aka "locality_fips"
    stringsAsFactors = FALSE) 
  #
  ht_precinct_vote_type_ids <- new.env()
  df_precinct_vote_type_ids <- data.frame(
    sid              = numeric(),
    cid              = numeric(),
    pid              = numeric(),
    vid              = numeric(),
    county_name      = character(), # aka "locality_name"
    precinct_id      = character(),
    vote_type        = character(),
    county_fips      = character(), # aka "locality_fips"
    precinct_geo_id  = character(), # aka "geo_id"
    precinct_name    = character(),
    # votes          = numeric(),
    # blankenshipd   = numeric(),
    # trumpd	       = numeric(),
    # hawkinsh	     = numeric(),
    # jorgensenj	   = numeric(),
    # bidenj	       = numeric(),
    # other	         = numeric(),
    # de_la_fuenter  = numeric(),
    stringsAsFactors = FALSE)
  time_origin_ms <- .Machine$double.xmax
  df_choices <- data.frame(
    choice_name   = character(),
    choice_weight = numeric(),
    stringsAsFactors = FALSE)
  for(iTimestampFilePostfix in 1:length(file_postfixes))
  {
    str_snapshot_timestamp <- file_postfixes[iTimestampFilePostfix] # e.g. "2020-11-03T23:40:53.084Z" or 1604475653084
    if(str_snapshot_timestamp != "latest")
    {
      num_snapshot_timestamp_ms <- round(as.numeric(strptime(str_snapshot_timestamp, "%Y-%m-%dT%H:%M:%OSZ"))*1000.0) # + 0.001
    } else
    {
      num_snapshot_timestamp_ms <- round(as.numeric(strptime(str_latest_snapshot_timestamp, "%Y-%m-%dT%H:%M:%OSZ"))*1000.0) # + 0.001
    }
    time_origin_ms <- ifelse(num_snapshot_timestamp_ms < time_origin_ms, num_snapshot_timestamp_ms, time_origin_ms)
    #
    json_postfix_out <- file_postfixes[iTimestampFilePostfix]
    json_postfix_out <- gsub("T","_", json_postfix_out)
    json_postfix_out <- gsub("Z", "", json_postfix_out)
    json_postfix_out <- gsub("-","_", json_postfix_out)
    json_postfix_out <- gsub(":","_", json_postfix_out)
    json_postfix_out <- gsub(".","_", json_postfix_out, fixed = TRUE)
    json_path_name <- paste0(json_path,"/", gsub("-","_", file_prefix),json_postfix_out,file_extension)
    
    print(paste0("Generating Precinct by Vote Types CSV for ", state_abbr, " at ", json_postfix_out))
    res <- jsonlite::read_json(path = json_path_name)
    
    if(length(res$precincts) > 0)
    {
      for(iPrecincts in 1:length(res$precincts))
      {
        # Use primary key {locality_name, precinct_id, vote_type} and {votes, bidenj, trumpd, jorgensenj, blankenshipd, hawkinsh, de_la_fuenter, other} as the contents
        #
        new_choices <- names(res$precincts[[iPrecincts]]$results)
        missing_choices_names <- new_choices[!(new_choices %in% df_choices$choice_name)]
        if(length(missing_choices_names) > 0)
        {
          for(choice_name in missing_choices_names)
          {
            df_choices_row <- data.frame(
              choice_name   = character(1),
              choice_weight = numeric(1),
              stringsAsFactors = FALSE)
            df_choices_row$choice_name <- choice_name
            df_choices_row$choice_weight <- 0
            df_choices <- rbind(df_choices,df_choices_row)
          }
        }
        if(iTimestampFilePostfix == length(file_postfixes))
        {
          for(choice_name in df_choices$choice_name)
          {
            if(choice_name %in% names(res$precincts[[iPrecincts]]$results))
            {
              df_choices$choice_weight[df_choices$choice_name == choice_name] <-
                df_choices$choice_weight[df_choices$choice_name == choice_name] +
                res$precincts[[iPrecincts]]$results[[choice_name]]
            }
          }
        }
        #
        if("vote_type" %in% names(res$precincts[[iPrecincts]]))
        {
          vote_type     <- res$precincts[[iPrecincts]]$vote_type
        } else
        {
          vote_type <- "unknown"
        }
        locality_name <- toupper(res$precincts[[iPrecincts]]$locality_name)
        precinct_id   <- res$precincts[[iPrecincts]]$precinct_id
        if("locality_fips" %in% names(res$precincts[[iPrecincts]]))
        {
          locality_fips     <- res$precincts[[iPrecincts]]$locality_fips
        } else
        {
          locality_fips <- "unknown"
        }
        if("geo_id" %in% names(res$precincts[[iPrecincts]]))
        {
          geo_id     <- res$precincts[[iPrecincts]]$geo_id
        } else
        {
          geo_id <- "unknown"
        }
        if("precinct_name" %in% names(res$precincts[[iPrecincts]]))
        {
          precinct_name     <- res$precincts[[iPrecincts]]$precinct_name
        } else
        {
          precinct_name <- "unknown"
        }
        locality_name__vote_type   <- paste0(locality_name, "|", vote_type)
        locality_name__precinct_id <- paste0(locality_name, "|", precinct_id)
        locality_name__precinct_id__vote_type <- paste0(locality_name, "|", precinct_id, "|", vote_type)

        if(!exists(vote_type, envir = ht_vote_type_ids, inherits = FALSE))
        {
          ht_vote_type_ids[[vote_type]] <- curr_vid
          df_vote_type_ids_row <- data.frame(
            sid              = numeric(1),
            vid              = numeric(1),
            vote_type        = character(1),
            stringsAsFactors = FALSE)
          df_vote_type_ids_row$sid[1]           <- sid
          df_vote_type_ids_row$vid[1]           <- curr_vid
          df_vote_type_ids_row$vote_type[1]     <- vote_type
          df_vote_type_ids <- rbind(df_vote_type_ids, df_vote_type_ids_row)
          curr_vid <- curr_vid + 1
        }
        if(!exists(locality_name, envir = ht_county_ids, inherits = FALSE))
        {
          ht_county_ids[[locality_name]] <- curr_cid
          df_county_ids_row <- data.frame(
            sid              = numeric(1),
            cid              = numeric(1),
            county_name      = character(1),
            county_fips      = character(1),
            stringsAsFactors = FALSE)
          df_county_ids_row$sid[1]         <- sid
          df_county_ids_row$cid[1]         <- curr_cid
          df_county_ids_row$county_name[1] <- locality_name
          df_county_ids_row$county_fips[1] <- locality_fips
          df_county_ids <- rbind(df_county_ids, df_county_ids_row)
          curr_cid <- curr_cid + 1
        }
        if(!exists(locality_name__precinct_id, envir = ht_precinct_ids, inherits = FALSE))
        {
          ht_precinct_ids[[locality_name__precinct_id]] <- curr_pid
          df_precinct_ids_row <- data.frame(
            sid              = numeric(1),
            cid              = numeric(1),
            pid              = numeric(1),
            county_name      = character(1),
            precinct_id      = character(1),
            county_fips      = character(1),
            precinct_geo_id  = character(1),
            precinct_name    = character(1),
            stringsAsFactors = FALSE)
          df_precinct_ids_row$sid[1]             <- sid
          df_precinct_ids_row$cid[1]             <- ht_county_ids[[locality_name]]
          df_precinct_ids_row$pid[1]             <- curr_pid
          df_precinct_ids_row$county_name[1]     <- locality_name
          df_precinct_ids_row$precinct_id[1]     <- precinct_id
          df_precinct_ids_row$county_fips[1]     <- locality_fips
          df_precinct_ids_row$precinct_geo_id[1] <- geo_id
          df_precinct_ids_row$precinct_name[1]   <- precinct_name
          df_precinct_ids <- rbind(df_precinct_ids, df_precinct_ids_row)
          curr_pid <- curr_pid + 1
        }
        if(!exists(locality_name__vote_type, envir = ht_county_vote_type_ids, inherits = FALSE))
        {
          ht_county_vote_type_ids[[locality_name__vote_type]] <- 1
          df_county_vote_type_ids_row <- data.frame(
            sid              = numeric(1),
            cid              = numeric(1),
            vid              = numeric(1),
            county_name      = character(1),
            vote_type        = character(1),
            county_fips      = character(1),
            stringsAsFactors = FALSE) 
          df_county_vote_type_ids_row$sid[1]         <- sid
          df_county_vote_type_ids_row$cid[1]         <- ht_county_ids[[locality_name]]
          df_county_vote_type_ids_row$vid[1]         <- ht_vote_type_ids[[vote_type]]
          df_county_vote_type_ids_row$county_name[1] <- locality_name
          df_county_vote_type_ids_row$vote_type[1]   <- vote_type
          df_county_vote_type_ids_row$county_fips[1] <- locality_fips
          df_county_vote_type_ids <- rbind(df_county_vote_type_ids, df_county_vote_type_ids_row)
        }
        if(!exists(locality_name__precinct_id__vote_type, envir = ht_precinct_vote_type_ids, inherits = FALSE))
        {
          ht_precinct_vote_type_ids[[locality_name__precinct_id__vote_type]] <- 1
          df_precinct_vote_type_ids_row <- data.frame(
            sid              = numeric(1),
            cid              = numeric(1),
            pid              = numeric(1),
            vid              = numeric(1),
            county_name      = character(1),
            precinct_id      = character(1),
            vote_type        = character(1),
            county_fips      = character(1),
            precinct_geo_id  = character(1),
            precinct_name    = character(1),
            stringsAsFactors = FALSE)
          df_precinct_vote_type_ids_row$sid[1]             <- sid
          df_precinct_vote_type_ids_row$cid[1]             <- ht_county_ids[[locality_name]]
          df_precinct_vote_type_ids_row$pid[1]             <- ht_precinct_ids[[locality_name__precinct_id]]
          df_precinct_vote_type_ids_row$vid[1]             <- ht_vote_type_ids[[vote_type]]
          df_precinct_vote_type_ids_row$county_name[1]     <- locality_name
          df_precinct_vote_type_ids_row$precinct_id[1]     <- precinct_id
          df_precinct_vote_type_ids_row$vote_type[1]       <- vote_type
          df_precinct_vote_type_ids_row$county_fips[1]     <- locality_fips
          df_precinct_vote_type_ids_row$precinct_geo_id[1] <- geo_id
          df_precinct_vote_type_ids_row$precinct_name[1]   <- precinct_name
          df_precinct_vote_type_ids <- rbind(df_precinct_vote_type_ids, df_precinct_vote_type_ids_row)
        }
      } # END for(iPrecincts in 1:length(res$precincts))
    } # END if(length(res$precincts) > 0)
  } # END for(iTimestampFilePostfix in 1:length(file_postfixes))

  if(time_origin_ms == .Machine$double.xmax)
  {
    time_origin_ms <- round(as.numeric(strptime(str_latest_snapshot_timestamp, "%Y-%m-%dT%H:%M:%OSZ"))*1000.0) # + 0.001
  }
  
  df_county_ids <- df_county_ids[order(df_county_ids$county_name),]
  df_precinct_ids <- df_precinct_ids[order(
    df_precinct_ids$county_name,
    df_precinct_ids$precinct_id),]
  df_vote_type_ids <- df_vote_type_ids[order(df_vote_type_ids$vote_type),]
  df_precinct_vote_type_ids <- df_precinct_vote_type_ids[order(
    df_precinct_vote_type_ids$county_name,
    df_precinct_vote_type_ids$precinct_id,
    df_precinct_vote_type_ids$vote_type),]
  df_choices <- df_choices[order(-df_choices$choice_weight),]
  
  write.csv(x = df_vote_type_ids, file = paste0(csv_path,"/",state_abbr,"_vote_type",".csv"), row.names = FALSE)
  write.csv(x = df_county_ids, file = paste0(csv_path,"/",state_abbr,"_county",".csv"), row.names = FALSE)
  write.csv(x = df_precinct_ids, file = paste0(csv_path,"/",state_abbr,"_precinct",".csv"), row.names = FALSE)
  write.csv(x = df_county_vote_type_ids, file = paste0(csv_path,"/",state_abbr,"_county_vote_type",".csv"), row.names = FALSE)
  write.csv(x = df_precinct_vote_type_ids, file = paste0(csv_path,"/",state_abbr,"_precinct_vote_type",".csv"), row.names = FALSE)

  return (list(
    ht_vote_type_ids = ht_vote_type_ids, df_vote_type_ids = df_vote_type_ids,
    ht_county_ids = ht_county_ids, df_county_ids = df_county_ids,
    ht_precinct_ids = ht_precinct_ids, df_precinct_ids = df_precinct_ids,
    df_county_vote_type_ids = df_county_vote_type_ids,
    df_precinct_vote_type_ids = df_precinct_vote_type_ids,
    time_origin_ms = time_origin_ms, df_choices = df_choices))
}

generate.precinct.votes.csv <- function(base_dir, time_origin_ms, sid, state_abbr,file_prefix,
                                        file_postfixes, ht_vote_type_ids, ht_county_ids, ht_precinct_ids,
                                        df_choices, negligible.choice.fraction.upper.threshold)
{
  json_path <- paste0(base_dir,"/input/elections-assets/2020/data/precincts")
  csv_path <- paste0(base_dir,"/input/elections-assets/2020/data/precincts/csv")
  df_choices_major <- df_choices[df_choices$choice_weight / sum(df_choices$choice_weight) >=
                                   negligible.choice.fraction.upper.threshold,]
  df_choices_minor <- df_choices[df_choices$choice_weight / sum(df_choices$choice_weight) <
                                   negligible.choice.fraction.upper.threshold,]
  if(nrow(df_choices_minor) > 0)
  {
    df_choices_major <- rbind(df_choices_major, data.frame(choice_name = "others",
                                choice_weight = sum(df_choices_minor$choice_weight), stringsAsFactors = FALSE))
  }
  for(iTimestampFilePostfix in 1:length(file_postfixes))
  {
    str_snapshot_timestamp <- file_postfixes[iTimestampFilePostfix] # e.g. "2020-11-03T23:40:53.084Z" or 1604475653084
    if(str_snapshot_timestamp != "latest")
    {
      num_snapshot_timestamp_ms <- round(as.numeric(strptime(str_snapshot_timestamp, "%Y-%m-%dT%H:%M:%OSZ"))*1000.0) # + 0.001
    } else
    {
      #if(length(file_postfixes) > 1)
      #{
      #  str_snapshot_timestamp_prev <- file_postfixes[iTimestampFilePostfix - 1]
      #  str_snapshot_timestamp_prev_prev <- file_postfixes[iTimestampFilePostfix - 2]
      #  num_snapshot_timestamp_ms_prev <- round(as.numeric(strptime(str_snapshot_timestamp_prev, "%Y-%m-%dT%H:%M:%OSZ"))*1000.0) # + 0.001
      #  num_snapshot_timestamp_ms_prev_prev <- round(as.numeric(strptime(str_snapshot_timestamp_prev_prev, "%Y-%m-%dT%H:%M:%OSZ"))*1000.0) # + 0.001
      #  num_snapshot_timestamp_ms <- num_snapshot_timestamp_ms_prev + (num_snapshot_timestamp_ms_prev - num_snapshot_timestamp_ms_prev_prev)
      #} else
      #{
        num_snapshot_timestamp_ms <- round(as.numeric(strptime(str_latest_snapshot_timestamp, "%Y-%m-%dT%H:%M:%OSZ"))*1000.0) # + 0.001
      #}
    }
    time_offset_ms <- num_snapshot_timestamp_ms - time_origin_ms
    #
    json_postfix_out <- file_postfixes[iTimestampFilePostfix]
    json_postfix_out <- gsub("T","_", json_postfix_out)
    json_postfix_out <- gsub("Z", "", json_postfix_out)
    json_postfix_out <- gsub("-","_", json_postfix_out)
    json_postfix_out <- gsub(":","_", json_postfix_out)
    json_postfix_out <- gsub(".","_", json_postfix_out, fixed = TRUE)
    json_path_name <- paste0(json_path,"/", gsub("-","_", file_prefix),json_postfix_out,file_extension)
    
    print(paste0("Generating Precinct by Vote Type and Vote Count Time Series CSV for ", state_abbr, " at ", json_postfix_out))
    res <- jsonlite::read_json(path = json_path_name)
    #
    # Use "res$precinct_by_vote_type" for {"PA", "FL} and "res$precincts" for {"NC", "MI", "GA"}
    if("precinct_by_vote_type" %in% names(res))
    {
      length_precinct_by_vote_type <- length(res$precinct_by_vote_type)
      use_long_name <- TRUE
    } else if("precincts" %in% names(res))
    {
      length_precinct_by_vote_type <- length(res$precincts)
      use_long_name <- FALSE
    } else
    {
      stop("Failed to find a field with vote counts in JSON file.")
    }
    #
    if(length_precinct_by_vote_type > 0)
    {
      df_precinct_votes <- data.frame(
        time_offset_ms   = numeric(length_precinct_by_vote_type),
        sid              = numeric(length_precinct_by_vote_type),
        cid              = numeric(length_precinct_by_vote_type),
        pid              = numeric(length_precinct_by_vote_type),
        vid              = numeric(length_precinct_by_vote_type),
        tally            = numeric(length_precinct_by_vote_type),
        stringsAsFactors = FALSE)
      for(iChoiceNameIndex in 1:nrow(df_choices_major))
      {
        df_precinct_votes[,paste0("votes_",df_choices_major$choice_name[iChoiceNameIndex])] =
          numeric(nrow(df_precinct_votes))
      }
      for(iPrecincts in 1:length_precinct_by_vote_type)
      {
        precinct_by_vote_type <- ifelse(use_long_name,
                                        res$precinct_by_vote_type[iPrecincts],
                                        res$precincts[iPrecincts])[[1]]
        locality_name <- toupper(precinct_by_vote_type$locality_name)
        precinct_id <- precinct_by_vote_type$precinct_id
        if("vote_type" %in% names(precinct_by_vote_type))
        {
          vid <- ht_vote_type_ids[[precinct_by_vote_type$vote_type]]
        } else
        {
          vid <- ht_vote_type_ids[["unknown"]]
        }
        #
        df_precinct_votes$time_offset_ms[iPrecincts] <- time_offset_ms
        df_precinct_votes$sid[iPrecincts]            <- sid
        df_precinct_votes$cid[iPrecincts]            <- ht_county_ids[[locality_name]]
        df_precinct_votes$pid[iPrecincts]            <- ht_precinct_ids[[paste0(locality_name, "|", precinct_id)]]
        df_precinct_votes$vid[iPrecincts]            <- vid
        df_precinct_votes$tally[iPrecincts]          <- ifelse("votes" %in% names(precinct_by_vote_type),
                                                               precinct_by_vote_type$votes, 0)
        df_precinct_votes[iPrecincts,colnames(df_precinct_votes)[startsWith(colnames(df_precinct_votes),"votes_")]] <- 0
        if(length(precinct_by_vote_type$results) > 0)
        {
          for(choice_name in names(precinct_by_vote_type$results))
          {
            if(choice_name %in% df_choices_major$choice_name & choice_name != "others")
            {
              df_precinct_votes[iPrecincts,paste0("votes_",choice_name)] <- precinct_by_vote_type$results[[choice_name]]
            } else
            {
              df_precinct_votes[iPrecincts,"votes_others"] <-
                df_precinct_votes[iPrecincts,"votes_others"] +
                precinct_by_vote_type$results[[choice_name]]
            }
          }
        }
      } # END for(iPrecincts in 1:length_precinct_by_vote_type)
    } else # END if(length_precinct_by_vote_type > 0)
    {
      df_precinct_votes <- data.frame(
        time_offset_ms   = numeric(),
        sid              = numeric(),
        cid              = numeric(),
        pid              = numeric(),
        vid              = numeric(),
        tally            = numeric(),
        stringsAsFactors = FALSE)
      for(iChoiceNameIndex in 1:nrow(df_choices_major))
      {
        df_precinct_votes[,paste0("votes_",df_choices_major$choice_name[iChoiceNameIndex])] =
          numeric(nrow(df_precinct_votes))
      }
    } # END else for "if(length_precinct_by_vote_type > 0)"
    df_precinct_votes <- df_precinct_votes[order(
      #df_precinct_votes$time_offset_ms,
      df_precinct_votes$sid,
      df_precinct_votes$cid,
      df_precinct_votes$pid,
      df_precinct_votes$vid),]
    if(iTimestampFilePostfix == 1)
    {
      write.csv(x = df_precinct_votes, file = paste0(csv_path,"/",state_abbr,"_precinct_vote_type_count_ts",".csv"),
                row.names = FALSE)
    } else
    {
      write.table(x = df_precinct_votes, file = paste0(csv_path,"/",state_abbr,"_precinct_vote_type_count_ts",".csv"),
                  sep = ",", append = TRUE, quote = FALSE,
                  col.names = FALSE, row.names = FALSE)
    }
  } # END for(iTimestampFilePostfix in 1:length(file_postfixes))
}

######################################################################################################

generate.rds.from.csv <- function(base_dir, state_abbr, bool.save.state = FALSE)
{
  csv_path <- paste0(base_dir,"/input/elections-assets/2020/data/precincts/csv")
  rds_path <- paste0(base_dir,"/input/elections-assets/2020/data/precincts/rds")

  array_file_postfixes <- c(
    "_vote_type",
    "_county",
    "_county_vote_type",
    "_precinct",
    "_precinct_vote_type",
    "_precinct_vote_type_count_ts"
  )

  if(!dir.exists(rds_path))
  {
    dir.create(rds_path)
  }
  
  if(bool.save.state)
  {
    df <- read.csv(file = paste0(csv_path,"/","state",".csv"))
    saveRDS(df, file = paste0(rds_path,"/","state",".rds"))
    # df_clone <- readRDS(file = paste0(rds_path,"/","state",".rds"))
  }
  
  for(iPosfixIndex in 1:length(array_file_postfixes))
  {
    df <- read.csv(file = paste0(csv_path,"/",state_abbr,array_file_postfixes[iPosfixIndex],".csv"))
    saveRDS(df, file = paste0(rds_path,"/",state_abbr,array_file_postfixes[iPosfixIndex],".rds"))
    # df_clone <- readRDS(file = paste0(rds_path,"/",state_abbr,array_file_postfixes[iPosfixIndex],".rds"))
  }
}

######################################################################################################

produce.plots <- function(base_dir, state_abbr, use.csv = FALSE)
{
  csv_path <- paste0(base_dir,"/input/elections-assets/2020/data/precincts/csv")
  rds_path <- paste0(base_dir,"/input/elections-assets/2020/data/precincts/rds")
  pdf_output_path <- paste0(base_dir,"/output/pdf")
  csv_output_path <- paste0(base_dir,"/output/csv")
  
  if(use.csv)
  {
    df_state <- read.csv(file = paste0(csv_path,"/","state",".csv"))
    df_vote_type <- read.csv(file = paste0(csv_path,"/",state_abbr,"_vote_type",".csv"))
    df_county <- read.csv(file = paste0(csv_path,"/",state_abbr,"_county",".csv"))
    df_county_vote_type <- read.csv(file = paste0(csv_path,"/",state_abbr,"_county_vote_type",".csv"))
    df_precinct <- read.csv(file = paste0(csv_path,"/",state_abbr,"_precinct",".csv"))
    df_precinct_vote_type <- read.csv(file = paste0(csv_path,"/",state_abbr,"_precinct_vote_type",".csv"))
    df_precinct_vote_type_count_ts <- read.csv(file = paste0(csv_path,"/",state_abbr,"_precinct_vote_type_count_ts",".csv"))
  } else
  {
    df_state <- readRDS(file = paste0(rds_path,"/","state",".rds"))
    df_vote_type <- readRDS(file = paste0(rds_path,"/",state_abbr,"_vote_type",".rds"))
    df_county <- readRDS(file = paste0(rds_path,"/",state_abbr,"_county",".rds"))
    df_county_vote_type <- readRDS(file = paste0(rds_path,"/",state_abbr,"_county_vote_type",".rds"))
    df_precinct <- readRDS(file = paste0(rds_path,"/",state_abbr,"_precinct",".rds"))
    df_precinct_vote_type <- readRDS(file = paste0(rds_path,"/",state_abbr,"_precinct_vote_type",".rds"))
    df_precinct_vote_type_count_ts <- readRDS(file = paste0(rds_path,"/",state_abbr,"_precinct_vote_type_count_ts",".rds"))
  }
  
  state_name <- df_state$state_name[df_state$state_abbr == state_abbr]
  time_origin_ms <- df_state$time_origin_ms[df_state$state_abbr == state_abbr]

  column_names_resid_votes <-
    colnames(df_precinct_vote_type_count_ts)[startsWith(colnames(df_precinct_vote_type_count_ts),"votes_")]
  column_names_resid_votes <-
    column_names_resid_votes[!(column_names_resid_votes %in% c("votes_trumpd", "votes_bidenj", "votes_others"))]
  if(!("votes_others" %in% colnames(df_precinct_vote_type_count_ts)))
  {
    df_precinct_vote_type_count_ts[,"votes_others"] <- 0
  }
  if(length(column_names_resid_votes) > 0)
  {
    for(iResidColIndex in 1:length(column_names_resid_votes))
    {
      df_precinct_vote_type_count_ts[,"votes_others"] <-
        df_precinct_vote_type_count_ts[,"votes_others"] +
        df_precinct_vote_type_count_ts[,c(column_names_resid_votes[iResidColIndex])]
      df_precinct_vote_type_count_ts[,c(column_names_resid_votes[iResidColIndex])] <- NULL
    }
  }
  
  if(state_abbr %in% c("FL", "MI", "GA", "NC", "PA"))
  {
    df_precinct_vote_type_count_ts.by_time <- groupBy(
      df = df_precinct_vote_type_count_ts, by = "time_offset_ms",
      clmns       = c("time_offset_ms", "sid", "tally", "votes_bidenj", "votes_trumpd", "votes_others"),
      aggregation = c("min",            "min", "sum",   "sum",          "sum",          "sum"),
      full.names = FALSE, na.rm = TRUE)
    df_precinct_vote_type_count_ts.by_time <- df_precinct_vote_type_count_ts.by_time[
      order(df_precinct_vote_type_count_ts.by_time$time_offset_ms),]
    #
    if(state_abbr == "FL")
    {
      xlims <- c(1.84e8, 2.0e8)
    } else if(state_abbr == "GA")
    {
      xlims <- c(2.7e8, 6.0e8)
    } else if(state_abbr == "MI")
    {
      xlims <- c(1.5e7, 1.2e8)
    } else if(state_abbr == "NC")
    {
      xlims <- c(3.92e8, 4.1e8)
    } else if(state_abbr == "PA")
    {
      xlims <- c(1.5e7, 1.2e8)
    } else
    {
      xlims <- c(0, max(df_precinct_vote_type_count_ts.by_time$time_offset_ms))
    }
    if(FALSE)
    {
      ylims <- c(0, max(df_precinct_vote_type_count_ts.by_time$tally))
      plot(x = df_precinct_vote_type_count_ts.by_time$time_offset_ms,
           y = df_precinct_vote_type_count_ts.by_time$tally,
           main = paste0("Tally for ", state_name, " (", state_abbr, ")"),
           xlab = "Time Offset (ms)", ylab = "Vote Tally Count",
           xlim = xlims, ylim <- ylims,
           pch = 20, lty = c("solid"), type = "b", col = "black", lwd = 2,
           cex = 1.5, cex.axis = 1.7, cex.lab = 1.7, cex.sub = 2, cex.main = 2)
    }
    #
    ylims <- c(0, max(df_precinct_vote_type_count_ts.by_time$votes_bidenj,
                      df_precinct_vote_type_count_ts.by_time$votes_trumpd,
                      df_precinct_vote_type_count_ts.by_time$votes_others))
    plot(x = df_precinct_vote_type_count_ts.by_time$time_offset_ms,
         y = df_precinct_vote_type_count_ts.by_time$votes_bidenj,
         main = paste0("Votes for ", state_name, " (", state_abbr, ")"),
         xlab = "Time Offset (ms)", ylab = "Vote Count for Choices",
         xlim = xlims, ylim <- ylims,
         pch = 20, lty = c("solid"), type = "b", col = "darkblue", lwd = 2,
         cex = 1.5, cex.axis = 1.7, cex.lab = 1.7, cex.sub = 2, cex.main = 2)
    lines(x = df_precinct_vote_type_count_ts.by_time$time_offset_ms,
          y = df_precinct_vote_type_count_ts.by_time$votes_trumpd,
          pch = 20, lty = c("solid"), type = "b", col = "darkred", lwd = 2,
          xaxt="n", yaxt ="n")
    lines(x = df_precinct_vote_type_count_ts.by_time$time_offset_ms,
          y = df_precinct_vote_type_count_ts.by_time$votes_others,
          pch = 20, lty = c("solid"), type = "b", col = "darkgreen", lwd = 2,
          xaxt="n", yaxt ="n")
    #abline(v=5e7, col=c("grey"),lwd=c(2),lty=c("dotted")) # dashed
    abline(h=0, col=c("black"),lwd=c(2),lty=c("solid"))
    legend.line1 <- "Biden"
    legend.line2 <- "Trump"
    legend.line3 <- "Others"
    #legend.line4 <- "Hour start"
    legend(x=xlims[1] + (xlims[2] - xlims[1])*2/3, y=ylims[1] + (ylims[2] - ylims[1])/3,
           legend=c(legend.line1,legend.line2,legend.line3),
           merge=FALSE, lwd=c(2), cex=c(1.3),
           col=c("darkblue","darkred","darkgreen"),
           lty=c("solid","solid","solid"))
    #grid(nx = 10, ny = 10, col="grey", lwd = 1)
  }
  # ...
}

####################################################################################################################

simpleCap <- function(x)
{
  s <- strsplit(x, " ")[[1]]
  r <- paste(toupper(substring(s, 1,1)), substring(s, 2), sep="", collapse=" ")
  s <- strsplit(r, "-")[[1]]
  r <- paste(toupper(substring(s, 1,1)), substring(s, 2), sep="", collapse="-")
  return(r)
}

download.json.generate.csv.for.fractions <- function(str.input.file.path, json_url_base,
                                                     bool.download.json, bool.generate.csv, bool.backup.csv,
                                                     race_strings, president_state_strings, senate_state_strings,
                                                     special_state_strings)
{
  # Data loading and preparation
  if(bool.download.json | bool.generate.csv | bool.backup.csv)
  {
    for(race_index in 1:length(race_strings))
    {
      race <- race_strings[race_index]
      if(race == "special")
      {
        url_string <- "senate/0/special.json"
        path_string <- "special"
        state_strings <- special_state_strings
      } else if (race == "president")
      {
        url_string <- "president.json"
        path_string <- "president"
        state_strings <- president_state_strings
      } else if (race == "senate")
      {
        url_string <- "senate.json"
        path_string <- "senate"
        state_strings <- senate_state_strings
      }
      
      for(state_index in 1:length(state_strings))
      {
        state_name <- state_strings[state_index]
        json_path <- paste0(str.input.file.path,"/",state_name)
        json_path_name <- paste0(json_path,"/",path_string,".json")
        json_url <- paste0(json_url_base, "/", state_name, "/", url_string)
        backup_json_path_name <- paste0(json_path_name,".backup")
        
        ########################################################################
        # Download JSON and Backup CSV
        if(bool.download.json)
        {
          resp <- GET(json_url)
          if (status_code(resp) == 200)
          {
            print(paste0("Downloading JSON for ", state_name, ", ", path_string))
            res <- jsonlite::fromJSON(json_url)
            
            if(!dir.exists(json_path))
            {
              dir.create(json_path, recursive = T)
            }
            if(bool.backup.csv & file.exists(json_path_name))
            {
              if(file.exists(backup_json_path_name))
              {
                file.remove(backup_json_path_name)
              }
              file.rename(from = json_path_name, to = backup_json_path_name)
            }
            jsonlite::write_json(res, path = json_path_name)
          }
        } else if(bool.backup.csv)
        {
          if(dir.exists(json_path) & file.exists(json_path_name))
          {
            if(file.exists(backup_json_path_name))
            {
              file.remove(backup_json_path_name)
            }
            file.copy(from = json_path_name, to = backup_json_path_name)
          }
        }
        if(!bool.backup.csv & file.exists(backup_json_path_name))
        {
          file.remove(backup_json_path_name)
        }
        ########################################################################
        
        ########################################################################
        # Generate CSV
        if(bool.generate.csv & file.exists(json_path_name))
        {
          print(paste0("Generating CSV for ", state_name, ", ", path_string))
          res <- jsonlite::read_json(path = json_path_name)
          timeseries <- res$data$races[[1]]$timeseries
          n <- length(timeseries)
          df.timeseries <- data.frame(eevp_source=character(n),
                                      timestamp=character(n),
                                      votes=integer(n),
                                      eevp=double(n),
                                      stringsAsFactors=FALSE)
          arr.choices.in <- names(timeseries[[1]]$vote_shares)
          if(length(arr.choices.in) > 0)
          {
            arr.choices.out <- paste0("vote_shares_", arr.choices.in)
            for(k in 1:length(arr.choices.out))
            {
              df.timeseries[arr.choices.out[k]] <- 0.0
            }
          } else
          {
            arr.choices.out <- arr.choices.in
          }
          for(j in 1:n)
          {
            df.timeseries$eevp_source[j] <- timeseries[[j]]$eevp_source
            df.timeseries$timestamp[j] <- timeseries[[j]]$timestamp
            df.timeseries$votes[j] <- timeseries[[j]]$votes
            df.timeseries$eevp[j] <- timeseries[[j]]$eevp
            if(length(arr.choices.in) > 0)
            {
              for(k in 1:length(arr.choices.out))
              {
                df.timeseries[j,arr.choices.out[k]] <- timeseries[[j]]$vote_shares[[arr.choices.in[k]]]
              }
            }
          }
          posix_time <- as.POSIXlt(strptime(df.timeseries$timestamp, "%Y-%m-%dT%H:%M:%SZ"))
          curr_time <- unclass(posix_time)
          df.timeseries$sec_offset <- as.numeric(posix_time)
          df.timeseries$year <- curr_time$year + 1900
          df.timeseries$mon  <- curr_time$mon + 1
          df.timeseries$mday <- curr_time$mday
          df.timeseries$hour <- curr_time$hour
          df.timeseries$min <- curr_time$min
          df.timeseries$sec <- curr_time$sec
          df.timeseries <- df.timeseries[,c("eevp_source","timestamp","year","mon","mday","hour","min","sec","sec_offset",
                                            "votes","eevp", arr.choices.out)]
          #
          csv_path_name <- paste0(json_path,"/",path_string,".csv")
          write.csv(x = df.timeseries, file = csv_path_name, row.names = FALSE)
        } # END if(bool.generate.csv & file.exists(json_path_name))
        ########################################################################
      } # END for(state_index in 1:length(state_strings))
    } # END for(race_index in 1:length(race_strings))
  } # END if(bool.download.json | bool.generate.csv | bool.backup.csv)
}

read.csv.prepare.fraction.data <- function(str.input.file.path, state_name,race)
{
  df_election_fractions <- NULL
  csv_path_name <- paste0(str.input.file.path,"/",state_name,"/",race,".csv")
  if(file.exists(csv_path_name))
  {
    # print(csv_path_name)
    df_election_fractions <- read.csv(file = csv_path_name, stringsAsFactors = FALSE, strip.white = TRUE, sep = ',')
    df_election_fractions <- df_election_fractions[df_election_fractions$eevp_source == "edison" &
                                                     df_election_fractions$votes > 0,]
    df_election_fractions <- df_election_fractions[order(df_election_fractions$sec_offset,
                                                         -df_election_fractions$votes),]
    df_election_fractions <- df_election_fractions[!duplicated(df_election_fractions$sec_offset),]
    rownames(df_election_fractions) <- NULL
    n <- nrow(df_election_fractions)
    #
    if(race == "president")
    {
      colnames(df_election_fractions)[colnames(df_election_fractions)=="vote_shares_trumpd"] <- "vote_shares_republican"
      colnames(df_election_fractions)[colnames(df_election_fractions)=="vote_shares_bidenj"] <- "vote_shares_democrat"
    } else if (race == "senate")
    {
      if(state_name != "west-virginia")
      {
        colnames(df_election_fractions)[colnames(df_election_fractions)==list_state_to_sen_cand_rep[[state_name]]] <- "vote_shares_republican"
      } else
      {
        df_election_fractions$vote_shares_republican <- 1 - df_election_fractions$vote_shares_swearenginp # vote_shares_capitos
      }
      if(state_name != "new-mexico")
      {
        colnames(df_election_fractions)[colnames(df_election_fractions)==list_state_to_sen_cand_dem[[state_name]]] <- "vote_shares_democrat"
      } else
      {
        df_election_fractions$vote_shares_democrat <- 1 - df_election_fractions$vote_shares_republican # vote_shares_lujanm
      }
      if(state_name == "louisiana")
      {
        df_election_fractions$vote_shares_republican <- df_election_fractions$vote_shares_republican + df_election_fractions$vote_shares_murphyd
        df_election_fractions$vote_shares_murphyd <- NULL
        df_election_fractions$vote_shares_democrat <- df_election_fractions$vote_shares_democrat + df_election_fractions$vote_shares_wenstrupp
        df_election_fractions$vote_shares_democrat <- df_election_fractions$vote_shares_democrat + df_election_fractions$vote_shares_perkinsa
        df_election_fractions$vote_shares_wenstrupp <- NULL
        df_election_fractions$vote_shares_perkinsa <- NULL
      }  
    } else if (race == "special")
    {
      colnames(df_election_fractions)[colnames(df_election_fractions)==list_state_to_spec_cand_rep[[state_name]]] <- "vote_shares_republican"
      if(state_name == "georgia")
      {
        df_election_fractions$vote_shares_republican <- df_election_fractions$vote_shares_republican + df_election_fractions$vote_shares_collinsd
        df_election_fractions$vote_shares_collinsd <- NULL
      }
      colnames(df_election_fractions)[colnames(df_election_fractions)==list_state_to_spec_cand_dem[[state_name]]] <- "vote_shares_democrat"
    }
    #
    df_election_fractions$vote_shares_republican_lb <- df_election_fractions$vote_shares_republican - 0.0005
    df_election_fractions$vote_shares_republican_lb[df_election_fractions$vote_shares_republican_lb < 0] <- 0
    #
    df_election_fractions$vote_shares_republican_ub <- df_election_fractions$vote_shares_republican + 0.0005
    df_election_fractions$vote_shares_republican_ub[df_election_fractions$vote_shares_republican_ub > 1] <- 1
    #
    df_election_fractions$vote_shares_democrat_lb <- df_election_fractions$vote_shares_democrat - 0.0005
    df_election_fractions$vote_shares_democrat_lb[df_election_fractions$vote_shares_democrat_lb < 0] <- 0
    #
    df_election_fractions$vote_shares_democrat_ub <- df_election_fractions$vote_shares_democrat + 0.0005
    df_election_fractions$vote_shares_democrat_ub[df_election_fractions$vote_shares_democrat_ub > 1] <- 1
    #
    df_election_fractions$vote_counts_republican_lb <- df_election_fractions$votes * df_election_fractions$vote_shares_republican_lb
    df_election_fractions$vote_counts_republican    <- df_election_fractions$votes * df_election_fractions$vote_shares_republican
    df_election_fractions$vote_counts_republican_ub <- df_election_fractions$votes * df_election_fractions$vote_shares_republican_ub
    #
    df_election_fractions$vote_counts_democrat_lb <- df_election_fractions$votes * df_election_fractions$vote_shares_democrat_lb
    df_election_fractions$vote_counts_democrat    <- df_election_fractions$votes * df_election_fractions$vote_shares_democrat
    df_election_fractions$vote_counts_democrat_ub <- df_election_fractions$votes * df_election_fractions$vote_shares_democrat_ub
    
    df_election_fractions$votes_delta <- c(0,df_election_fractions$votes[2:n] - df_election_fractions$votes[1:(n-1)])
    df_election_fractions$votes_republican_delta <- c(0,df_election_fractions$vote_counts_republican[2:n] - df_election_fractions$vote_counts_republican[1:(n-1)])
    df_election_fractions$votes_democrat_delta <- c(0,df_election_fractions$vote_counts_democrat[2:n] - df_election_fractions$vote_counts_democrat[1:(n-1)])
    df_election_fractions$vote_shares_republican_delta <- df_election_fractions$votes_republican_delta / df_election_fractions$votes_delta
    df_election_fractions$vote_shares_democrat_delta <- df_election_fractions$votes_democrat_delta / df_election_fractions$votes_delta
    
    df_election_fractions$time_delta_sec <- c(0,df_election_fractions$sec_offset[2:n] - df_election_fractions$sec_offset[1:(n-1)])
    df_election_fractions$time <- strptime(df_election_fractions$timestamp,"%Y-%m-%dT%H:%M:%OSZ")
    df_election_fractions$sec_offset2 <- as.numeric(df_election_fractions$time)
    df_election_fractions$time2 <- as.POSIXct(df_election_fractions$sec_offset2, origin = "1970-01-01")
    #df_election_fractions[,c("timestamp","sec_offset","sec_offset2","time","time2")]
    
    df_election_fractions$republican_stat <- c(0,(df_election_fractions$vote_shares_republican_delta[2:n] -
                                                    df_election_fractions$vote_shares_republican[1:(n-1)]) /
                                             df_election_fractions$vote_shares_republican[1:(n-1)] *
                                             (df_election_fractions$votes_delta[2:n] / df_election_fractions$votes[n]))
    df_election_fractions$democrat_stat <- c(0,(df_election_fractions$vote_shares_democrat_delta[2:n] -
                                                  df_election_fractions$vote_shares_democrat[1:(n-1)]) /
                                             df_election_fractions$vote_shares_democrat[1:(n-1)] *
                                             (df_election_fractions$votes_delta[2:n] / df_election_fractions$votes[n]))
    df_election_fractions$republican_stat[is.infinite(df_election_fractions$republican_stat)] <- NaN
    df_election_fractions$democrat_stat[is.infinite(df_election_fractions$democrat_stat)] <- NaN
    
    df_election_fractions$votes_pct <- df_election_fractions$votes / df_election_fractions$votes[n] * 100
  }
  return(df_election_fractions)
}
  
plot.batch.impact <- function(str_curr_min_time = NA, str_curr_max_time = NA,
                              df_election_fractions,
                              race, state_name, json_url, my_github_base, int.time.last.flip,
                              ylims.batch.size = NULL, ylims.batch.impact = NULL)
{
  xlims <- compute.xlims.lower.time(
    str_curr_min_time = str_curr_min_time,
    str_curr_max_time = str_curr_max_time,
    df_election_fractions = df_election_fractions)
  
  df_election_fractions_subinterval <- df_election_fractions[df_election_fractions$sec_offset >= xlims[1] &
                                                               df_election_fractions$sec_offset <= xlims[2],]
  if(nrow(df_election_fractions_subinterval) > 1)
  {
    if(sum(is.na(df_election_fractions_subinterval$republican_stat)) == length(df_election_fractions_subinterval$republican_stat))
    {
      df_election_fractions_subinterval$republican_stat <- 0
    }
    if(sum(is.na(df_election_fractions_subinterval$democrat_stat)) == length(df_election_fractions_subinterval$democrat_stat))
    {
      df_election_fractions_subinterval$democrat_stat <- 0
    }
    if((min(df_election_fractions_subinterval$vote_shares_republican) < max(df_election_fractions_subinterval$vote_shares_republican) |
        min(df_election_fractions_subinterval$vote_shares_democrat) < max(df_election_fractions_subinterval$vote_shares_democrat)) &
       (min(df_election_fractions_subinterval$vote_counts_republican) < max(df_election_fractions_subinterval$vote_counts_republican) |
        min(df_election_fractions_subinterval$vote_counts_democrat) < max(df_election_fractions_subinterval$vote_counts_democrat)) &
       min(df_election_fractions_subinterval$votes_pct) < max(df_election_fractions_subinterval$votes_pct) &
       (min(df_election_fractions_subinterval$republican_stat, na.rm = TRUE) < max(df_election_fractions_subinterval$republican_stat, na.rm = TRUE) |
        min(df_election_fractions_subinterval$democrat_stat, na.rm = TRUE) < max(df_election_fractions_subinterval$democrat_stat, na.rm = TRUE)))
    {
      plot.batch.size.barchart(df_election_fractions = df_election_fractions,
                               xlims = xlims, ylims.batch.size = ylims.batch.size)
      par(new = T, xpd=FALSE)
      lab.list.x.pos <- plot.batch.impact.statistic(df_election_fractions = df_election_fractions,
                                                    xlims = xlims,
                                                    race = race,
                                                    state_name = state_name,
                                                    json_url = json_url,
                                                    my_github_base = my_github_base,
                                                    ylims.batch.impact = ylims.batch.impact)
      par(new = T, xpd=FALSE)
      ylims <- plot.cumulative.tally.percent(df_election_fractions = df_election_fractions,
                                             xlims = xlims, lab.list.x.pos = lab.list.x.pos)
      if(!is.na(int.time.last.flip))
      {
        abline(h=int.time.last.flip,col = "cyan", lty = "dashed", lwd = 1)
      }
      legend.line1 <- "Democrat"
      legend.line2 <- "Republican"
      legend.line3 <- "Final Tally %"
      legend.line4 <- "Batch Size (+)"
      legend.line5 <- "Batch Size (-)"
      legend(x=xlims[1] + (xlims[2] - xlims[1])*5/100, y=ylims[1] + (ylims[2] - ylims[1])*95/100,
             legend=c(legend.line1,legend.line2,legend.line3,legend.line4,legend.line5),
             merge=FALSE, lwd=c(1,1,1,6,6), cex=c(0.75),
             col=c("blue","red", "black", "darkgrey","pink"),
             lty=c("solid","solid","solid","solid","solid"))
    }
  }
}

plot.cumulative.votes <- function(str_curr_min_time = NA, str_curr_max_time = NA,
                                  df_election_fractions,
                                  race, state_name, json_url, my_github_base, int.time.last.flip,
                                  ylims.batch.size = NULL, ylims.cumulative.votes = NULL)
{
  xlims <- compute.xlims.lower.time(
    str_curr_min_time = str_curr_min_time,
    str_curr_max_time = str_curr_max_time,
    df_election_fractions = df_election_fractions)
  
  df_election_fractions_subinterval <- df_election_fractions[df_election_fractions$sec_offset >= xlims[1] &
                                                            df_election_fractions$sec_offset <= xlims[2],]
  if(nrow(df_election_fractions_subinterval) > 1)
  {
    if(sum(is.na(df_election_fractions_subinterval$republican_stat)) == length(df_election_fractions_subinterval$republican_stat))
    {
      df_election_fractions_subinterval$republican_stat <- 0
    }
    if(sum(is.na(df_election_fractions_subinterval$democrat_stat)) == length(df_election_fractions_subinterval$democrat_stat))
    {
      df_election_fractions_subinterval$democrat_stat <- 0
    }
    if((min(df_election_fractions_subinterval$vote_shares_republican) < max(df_election_fractions_subinterval$vote_shares_republican) |
        min(df_election_fractions_subinterval$vote_shares_democrat) < max(df_election_fractions_subinterval$vote_shares_democrat)) &
       (min(df_election_fractions_subinterval$vote_counts_republican) < max(df_election_fractions_subinterval$vote_counts_republican) |
        min(df_election_fractions_subinterval$vote_counts_democrat) < max(df_election_fractions_subinterval$vote_counts_democrat)) &
       min(df_election_fractions_subinterval$votes_pct) < max(df_election_fractions_subinterval$votes_pct) &
       (min(df_election_fractions_subinterval$republican_stat, na.rm = TRUE) < max(df_election_fractions_subinterval$republican_stat, na.rm = TRUE) |
        min(df_election_fractions_subinterval$democrat_stat, na.rm = TRUE) < max(df_election_fractions_subinterval$democrat_stat, na.rm = TRUE)))
    {
      plot.batch.size.barchart(df_election_fractions = df_election_fractions,
                               xlims = xlims, ylims.batch.size = ylims.batch.size)
      par(new = T, xpd=FALSE)
      lab.list.x.pos <- plot.cumulative.vote.counts(df_election_fractions = df_election_fractions,
                                                    xlims = xlims,
                                                    race = race,
                                                    state_name = state_name,
                                                    json_url = json_url,
                                                    my_github_base = my_github_base,
                                                    ylims.cumulative.votes = ylims.cumulative.votes)
      par(new = T, xpd=FALSE)
      ylims <- plot.cumulative.tally.percent(df_election_fractions = df_election_fractions,
                                             xlims = xlims, lab.list.x.pos = lab.list.x.pos)
      if(!is.na(int.time.last.flip))
      {
        abline(h=int.time.last.flip,col = "cyan", lty = "dashed", lwd = 1)
      }
      legend.line1 <- "Democrat"
      legend.line2 <- "Republican"
      legend.line3 <- "Final Tally %"
      legend.line4 <- "Batch Size (+)"
      legend.line5 <- "Batch Size (-)"
      legend(x=xlims[1] + (xlims[2] - xlims[1])*5/100, y=ylims[1] + (ylims[2] - ylims[1])*95/100,
             legend=c(legend.line1,legend.line2,legend.line3,legend.line4,legend.line5),
             merge=FALSE, lwd=c(1,1,1,6,6), cex=c(0.75),
             col=c("blue","red", "black", "darkgrey","pink"),
             lty=c("solid","solid","solid","solid","solid"))
    }
  }
}

compute.xlims.lower.time <- function(str_curr_min_time = NA, str_curr_max_time = NA, df_election_fractions)
{
  #xmin <- as.numeric(strptime("2020-11-03T21:00:00Z", "%Y-%m-%dT%H:%M:%OSZ"))
  #xmax <- as.numeric(strptime("2020-11-05T00:00:00Z", "%Y-%m-%dT%H:%M:%OSZ"))
  if(is.na(str_curr_min_time))
  {
    xmin <- min(df_election_fractions$sec_offset, na.rm = TRUE)
  } else
  {
    xmin <- as.numeric(strptime(str_curr_min_time, "%Y-%m-%dT%H:%M:%OSZ"))
  }
  if(is.na(str_curr_max_time))
  {
    xmax <- max(df_election_fractions$sec_offset, na.rm = TRUE)
  } else
  {
    xmax <- as.numeric(strptime(str_curr_max_time, "%Y-%m-%dT%H:%M:%OSZ"))
  }
  xmin <- min(xmin, xmax)
  xmax <- max(xmin, xmax)
  xlims <- c(xmin, xmax)
  return(xlims)
}

plot.cumulative.vote.fractions <- function(str_curr_min_time = NA, str_curr_max_time = NA, df_election_fractions,
                                           race, state_name, json_url, my_github_base, int.time.last.flip,
                                           ylims.batch.size = NULL, ylims.cumulative.vote.fractions = NULL)
{
  xlims <- compute.xlims.lower.time(
    str_curr_min_time = str_curr_min_time,
    str_curr_max_time = str_curr_max_time,
    df_election_fractions = df_election_fractions)
  
  df_election_fractions_subinterval <- df_election_fractions[df_election_fractions$sec_offset >= xlims[1] &
                                                               df_election_fractions$sec_offset <= xlims[2],]
  if(nrow(df_election_fractions_subinterval) > 1)
  {
    if(sum(is.na(df_election_fractions_subinterval$republican_stat)) == length(df_election_fractions_subinterval$republican_stat))
    {
      df_election_fractions_subinterval$republican_stat <- 0
    }
    if(sum(is.na(df_election_fractions_subinterval$democrat_stat)) == length(df_election_fractions_subinterval$democrat_stat))
    {
      df_election_fractions_subinterval$democrat_stat <- 0
    }
    if((min(df_election_fractions_subinterval$vote_shares_republican) < max(df_election_fractions_subinterval$vote_shares_republican) |
        min(df_election_fractions_subinterval$vote_shares_democrat) < max(df_election_fractions_subinterval$vote_shares_democrat)) &
       (min(df_election_fractions_subinterval$vote_counts_republican) < max(df_election_fractions_subinterval$vote_counts_republican) |
        min(df_election_fractions_subinterval$vote_counts_democrat) < max(df_election_fractions_subinterval$vote_counts_democrat)) &
       min(df_election_fractions_subinterval$votes_pct) < max(df_election_fractions_subinterval$votes_pct) &
       (min(df_election_fractions_subinterval$republican_stat, na.rm = TRUE) < max(df_election_fractions_subinterval$republican_stat, na.rm = TRUE) |
        min(df_election_fractions_subinterval$democrat_stat, na.rm = TRUE) < max(df_election_fractions_subinterval$democrat_stat, na.rm = TRUE)))
    {
      plot.batch.size.barchart(df_election_fractions = df_election_fractions,
                               xlims = xlims, ylims.batch.size = ylims.batch.size)
      par(new = T, xpd=FALSE)
      lab.list.x.pos <- plot.cumulative.vote.fracs(df_election_fractions = df_election_fractions,
                                                   xlims = xlims,
                                                   race = race,
                                                   state_name = state_name,
                                                   json_url = json_url,
                                                   my_github_base = my_github_base,
                                                   ylims.cumulative.vote.fractions = ylims.cumulative.vote.fractions)
      par(new = T, xpd=FALSE)
      ylims <- plot.cumulative.tally.percent(df_election_fractions = df_election_fractions,
                                             xlims = xlims, lab.list.x.pos = lab.list.x.pos)
      if(!is.na(int.time.last.flip))
      {
        abline(v=int.time.last.flip,col = "cyan", lty = "dashed", lwd = 1)
      }
      legend.line1 <- "Democrat"
      legend.line2 <- "Republican"
      legend.line3 <- "Final Tally %"
      legend.line4 <- "Batch Size (+)"
      legend.line5 <- "Batch Size (-)"
      legend(x=xlims[1] + (xlims[2] - xlims[1])*5/100, y=ylims[1] + (ylims[2] - ylims[1])*95/100,
             legend=c(legend.line1,legend.line2,legend.line3,legend.line4,legend.line5),
             merge=FALSE, lwd=c(1,1,1,6,6), cex=c(0.75),
             col=c("blue","red", "black", "darkgrey","pink"),
             lty=c("solid","solid","solid","solid","solid"))
    }
  }
}

compute.ylims.right.batch.size <- function(df_election_fractions, xlims)
{
  n <- nrow(df_election_fractions)
  widths <- c()
  heights <- c()
  if(xlims[1] < df_election_fractions$sec_offset[1])
  {
    indexObsBeforeInterval <- 0
    widths <- c(widths, df_election_fractions$sec_offset[indexObsBeforeInterval+1] - xlims[1])
    heights <- c(heights, df_election_fractions$votes_delta[indexObsBeforeInterval+1])
  } else if(xlims[1] >= df_election_fractions$sec_offset[1])
  {
    indexObsBeforeInterval <- max(which(df_election_fractions$sec_offset <= xlims[1]))
    widths <- c(widths, df_election_fractions$sec_offset[indexObsBeforeInterval+1] - xlims[1])
    heights <- c(heights, df_election_fractions$votes_delta[indexObsBeforeInterval+1] *
                   ( (df_election_fractions$sec_offset[indexObsBeforeInterval+1] - xlims[1]) /
                       (df_election_fractions$sec_offset[indexObsBeforeInterval+1] -
                          df_election_fractions$sec_offset[indexObsBeforeInterval]) ) )
  }
  widths <- c(widths, df_election_fractions$time_delta_sec[
    df_election_fractions$sec_offset > df_election_fractions$sec_offset[indexObsBeforeInterval+1] &
      df_election_fractions$sec_offset <= xlims[2]])
  heights <- c(heights, df_election_fractions$votes_delta[
    df_election_fractions$sec_offset > df_election_fractions$sec_offset[indexObsBeforeInterval+1] &
      df_election_fractions$sec_offset <= xlims[2]])
  if(xlims[2] > df_election_fractions$sec_offset[n])
  {
    widths <- c(widths, xlims[2] - df_election_fractions$sec_offset[n])
    heights <- c(heights, 0)
  } else if(xlims[2] < df_election_fractions$sec_offset[n])
  {
    indexObsAfterInterval <- max(which(df_election_fractions$sec_offset < xlims[2]))
    widths <- c(widths, xlims[2] - df_election_fractions$sec_offset[indexObsAfterInterval])
    heights <- c(heights, df_election_fractions$votes_delta[indexObsAfterInterval+1] *
                   ( (xlims[2] - df_election_fractions$sec_offset[indexObsAfterInterval]) /
                       (df_election_fractions$sec_offset[indexObsAfterInterval+1] -
                          df_election_fractions$sec_offset[indexObsAfterInterval]) ) )
  }
  heights.non.negative <- heights
  heights.non.negative[heights.non.negative < 0] <- 0
  heights.non.positive <- heights
  heights.non.positive[heights.non.positive > 0] <- 0
  heights.non.positive <- -heights.non.positive
  
  # https://stackoverflow.com/questions/34204198/how-to-superimpose-bar-plots-in-r
  # Plot the new data with a different ylim, but don't plot the axis
  ylims <- c(0, max(heights.non.negative, heights.non.positive) * 1.1)
  return(list(ylims = ylims, widths = widths, heights = heights,
              heights.non.negative = heights.non.negative, heights.non.positive = heights.non.positive))
}

plot.batch.size.barchart <- function(df_election_fractions, xlims, ylims.batch.size = NULL)
{
  list.ylims.info <- compute.ylims.right.batch.size(
    df_election_fractions = df_election_fractions, xlims = xlims)
  if(is.null(ylims.batch.size))
  {
    ylims <- list.ylims.info[["ylims"]]
  } else
  {
    ylims <- ylims.batch.size
  }
  widths <- list.ylims.info[["widths"]]
  heights <- list.ylims.info[["heights"]]
  heights.non.negative <- list.ylims.info[["heights.non.negative"]]
  heights.non.positive <- list.ylims.info[["heights.non.positive"]]

  # https://stackoverflow.com/questions/34204198/how-to-superimpose-bar-plots-in-r
  # Plot the new data with a different ylim, but don't plot the axis
  barplot(width=widths,
          height=heights.non.negative,
          col = "darkgrey", border = "darkgrey", lwd = 1, las = 1,
          ylim = ylims,
          cex = 1, cex.axis = 1, cex.lab = 1, cex.sub = 1, cex.main = 1,
          space = 0, xaxt = "n", yaxt = "n", xaxs ="i", yaxs = "i")
  par(new = T, xpd=FALSE)
  barplot(width=widths,
          height=heights.non.positive,
          col = "pink", border = "pink", lwd = 1, las = 1,
          ylim = ylims,
          cex = 1, cex.axis = 1, cex.lab = 1, cex.sub = 1, cex.main = 1,
          space = 0, xaxt = "n", yaxt = "n", xaxs ="i", yaxs = "i")
  # Add the axis on the right
  par(family="mono") # By default Courier
  lab.list.y.right.pos <- seq(ylims[1], ylims[2], (ylims[2] - ylims[1]) / 35)
  if(ylims[2] - ylims[1] > 9999000)
  {
    lab.list.y.right.text <- sprintf("%04dM", round(lab.list.y.right.pos/1000000, 0))
  } else if(ylims[2] - ylims[1] > 9999)
  {
    lab.list.y.right.text <- sprintf("%04dK", round(lab.list.y.right.pos/1000, 0))
  } else
  {
    lab.list.y.right.text <- sprintf("%04d", round(lab.list.y.right.pos/1, 0))
  }
  axis(side = 4, at = lab.list.y.right.pos, labels = lab.list.y.right.text,
       las = 2, cex.axis = 0.75, padj = 1.5, mgp = c(3, 0, 0), font.axis=2)
  mtext(expression(paste(bold("Batch Size (# votes)"))), side=4, line=-1.5, font.lab=2)
  abline(h=lab.list.y.right.pos,col = "lightgray", lty = "dotted", lwd = 1)
}

draw.timeline.ticks.labels <- function(xlims, ylims)
{
  par(family="mono") # By default Courier
  #print(paste0(ceiling((xlims[2] - xlims[1])/1),"; ",
  #             ceiling((xlims[2] - xlims[1])/60),"; ",
  #             ceiling((xlims[2] - xlims[1])/3600),"; ",
  #             ceiling((xlims[2] - xlims[1])/86400),"; "))
  max.num.sub.intervals <- 60
  full.interval.length.secs <- xlims[2] - xlims[1]
  threshold.format.change <- 0.25
  if(ceiling((xlims[2] - xlims[1])/60) / max.num.sub.intervals < threshold.format.change)
  {
    increment_secs <- 1 * ceiling(ceiling((xlims[2] - xlims[1])/1) / max.num.sub.intervals)
    increment_name <- "second"
    label.format.template <- "%H%M%S"
    x.axis.label <- paste0("Nov. ", format(as.POSIXct(xlims[1], origin = "1970-01-01"),"%d"),
      ", 2020, <Hour Start (00-23)><Minute Start (00-59)><Second Start (00-59)>")
  } else
  if(ceiling((xlims[2] - xlims[1])/3600) / max.num.sub.intervals < threshold.format.change)
  {
    increment_secs <- 60 * ceiling(ceiling((xlims[2] - xlims[1])/60) / max.num.sub.intervals)
    increment_name <- "minute"
    label.format.template <- "%d%H%M"
    x.axis.label <- "<Nov., 2020 Date><Hour Start (00-23)><Minute Start (00-59)>"
  } else if(ceiling((xlims[2] - xlims[1])/86400) / max.num.sub.intervals < threshold.format.change)
  {
    increment_secs <- 3600 * ceiling(ceiling((xlims[2] - xlims[1])/3600) / max.num.sub.intervals)
    increment_name <- "hour"
    label.format.template <- "%d-%H"
    x.axis.label <- "<Nov., 2020 Date>-<Hour Start (00-23)>"
  } else
  {
    increment_secs <- 86400 * ceiling(ceiling((xlims[2] - xlims[1])/86400) / max.num.sub.intervals)
    increment_name <- "day"
    label.format.template <- "%m-%d"
    x.axis.label <- "<2020 Month>-<Date Start (01-31)>"
  }
  lab.list.x.pos <- as.numeric(seq(
    lubridate::ceiling_date(as.POSIXct(xlims[1], origin = "1970-01-01"), unit = increment_name),
    lubridate::floor_date(as.POSIXct(xlims[2], origin = "1970-01-01"), unit = increment_name),
    increment_secs))
  lab.list.x.text <- as.POSIXct(lab.list.x.pos, origin = "1970-01-01")
  m <- length(lab.list.x.text)
  axis(side = 1, at = lab.list.x.pos, labels = FALSE)
  text(lab.list.x.pos[1:(m-1)] + 0.1 * increment_secs, ylims[1],
       labels = format(lab.list.x.text[1:(m-1)], format=label.format.template),
       srt = 90, pos = 1, xpd = TRUE, cex = 0.75, offset = 1.15)
  abline(v=lab.list.x.pos,col = "lightgray", lty = "dotted", lwd = 1)
  return(list(x.axis.label = x.axis.label,lab.list.x.pos = lab.list.x.pos))
}

compute.ylims.left.batch.impact.statistic <- function(df_election_fractions, xlims)
{
  ylims <- c(min(df_election_fractions$republican_stat[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                 df_election_fractions$democrat_stat[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                 na.rm = TRUE),
             max(df_election_fractions$republican_stat[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                 df_election_fractions$democrat_stat[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                 na.rm = TRUE))
  return(ylims)
}

plot.batch.impact.statistic <- function(df_election_fractions, xlims,
                                        race, state_name, json_url, my_github_base, ylims.batch.impact = NULL)
{
  if(is.null(ylims.batch.impact))
  {
    ylims <- compute.ylims.left.batch.impact.statistic(df_election_fractions = df_election_fractions, xlims = xlims)
  } else
  {
    ylims <- ylims.batch.impact
  }
  par(family="sans") # By default Helvetica which is like Arial
  plot(x = df_election_fractions$sec_offset,
       y = rep(0,length(df_election_fractions$sec_offset)),
       main = "", xlab = "", ylab="", xaxt="n", yaxt ="n",
       xlim = xlims, ylim = ylims,
       pch = 20, lty = c("dashed"), type = "n", col = "black", lwd = 1,
       cex = 1, cex.axis = 1, cex.lab = 1, cex.sub = 1, cex.main = 1,
       xaxs ="i", yaxs = "i")
  #
  list.timeline.ticks.rslt <- draw.timeline.ticks.labels(xlims = xlims, ylims = ylims)
  x.axis.label <- list.timeline.ticks.rslt[["x.axis.label"]]
  lab.list.x.pos <- list.timeline.ticks.rslt[["lab.list.x.pos"]]
  #
  par(family="mono") # By default Courier
  step <- (ylims[2] - ylims[1]) / 35
  if(ylims[1] < 0)
  {
    below.zero.y <- seq(0,ylims[1], -step)
    below.zero.y <- below.zero.y[order(below.zero.y)]
  } else
  {
    below.zero.y <- c()
  }
  if(ylims[2] > 0)
  {
    above.zero.y <- seq(0,ylims[2], step)
    above.zero.y <- above.zero.y[1:(length(above.zero.y)-1)]
  } else
  {
    above.zero.y <- c()
  }
  lab.list.y.pos <- c(below.zero.y, above.zero.y)
  lab.list.y.text <- sprintf("%3.3f", round(lab.list.y.pos, 3))
  axis(side = 2, at = lab.list.y.pos, labels = lab.list.y.text,
       las = 2, cex.axis = 0.75, padj = 1.5, mgp = c(3, 0, 0), font.axis=2)
  abline(h=lab.list.y.pos,col = "lightgray", lty = "dotted", lwd = 1)
  #
  options(digits.secs = 3)
  min_time <- gsub("\\.",":",format(as.POSIXct(xlims[1], origin = "1970-01-01"), "%Y-%m-%d, %H:%M:%OS"))
  max_time <- gsub("\\.",":",format(as.POSIXct(xlims[2], origin = "1970-01-01"), "%Y-%m-%d, %H:%M:%OS"))
  #title(main = "Impacts of vote batches on the", line=3.4, cex.main=1)
  title(main = paste0("Vote batch impact on US ", sapply(gsub("president","presidential",race),simpleCap),
                      " General Election 2020 results in ",
                      sapply(state_name,simpleCap)), line=3, cex.main=1.1)
  title(main = paste0("from ", min_time, " to ", max_time), line=2.2, cex.main=1.1)
  #title(main = "Final Tally %", line=-1, cex.main=1)
  title(ylab="[(Batch % - Cumul. %) / Cumul. %] * (Batch Size / Final Tally)",
        line=2.2, cex.lab=1, font.lab=2)
  title(xlab=x.axis.label,
        line=2, cex.lab=1, font.lab=2)
  #title(xlab=paste0("Data source: ", json_url), line=3, cex.lab=0.75, font.lab=3)
  title(xlab=bquote(bold('Data Source (replace "-"): ') ~ italic(.(json_url))),
        line=2.75, cex.lab=0.75, font.lab=3, col.lab = "darkgreen")
  title(xlab=bquote(bold('Code source: ') ~ italic(.(my_github_base))),
        line=3.5, cex.lab=0.75, font.lab=3, col.lab = "darkgreen")
  options(digits.secs = 3)
  current_time <- gsub("\\.",":",format(Sys.time(), "%Y:%m:%d:%H:%M:%OS"))
  title(xlab=bquote(bold('Current time: ') ~ italic(.(current_time))),
        line=4, cex.lab=0.7, font.lab=3, col.lab = "red")
  #
  lines(x = df_election_fractions$sec_offset,
        y = df_election_fractions$republican_stat,
        pch = 20, lty = c("solid"), type = "l", col = "red", lwd = 1,
        xaxt="n", yaxt ="n")
  lines(x = df_election_fractions$sec_offset,
        y = df_election_fractions$democrat_stat,
        pch = 20, lty = c("solid"), type = "l", col = "blue", lwd = 1,
        xaxt="n", yaxt ="n")
  abline(h=0, col = c("black"), lwd=c(1), lty=c("dashed"))
  return(lab.list.x.pos)
}

compute.ylims.left.cum.votes <- function(df_election_fractions, xlims)
{
  #df_election_fractions_subinterval <- df_election_fractions[df_election_fractions$sec_offset >= xlims[1] &
  #                                                             df_election_fractions$sec_offset <= xlims[2],]
  ylims <- c(min(df_election_fractions$vote_counts_republican_lb[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                 df_election_fractions$vote_counts_republican[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                 df_election_fractions$vote_counts_republican_ub[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                 df_election_fractions$vote_counts_democrat_lb[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                 df_election_fractions$vote_counts_democrat[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                 df_election_fractions$vote_counts_democrat_ub[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                 na.rm = TRUE)
             ,max(df_election_fractions$vote_counts_republican_lb[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                  df_election_fractions$vote_counts_republican[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                  df_election_fractions$vote_counts_republican_ub[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                  df_election_fractions$vote_counts_democrat_lb[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                  df_election_fractions$vote_counts_democrat[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                  df_election_fractions$vote_counts_democrat_ub[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                  na.rm = TRUE))
  return(ylims)
}

plot.cumulative.vote.counts <- function(df_election_fractions, xlims,
                                        race, state_name, json_url, my_github_base, ylims.cumulative.votes = NULL)
{
  if(is.null(ylims.cumulative.votes))
  {
    ylims <- compute.ylims.left.cum.votes(df_election_fractions = df_election_fractions, xlims = xlims)
  } else
  {
    ylims <- ylims.cumulative.votes
  }
  n <- nrow(df_election_fractions)
  par(family="sans") # By default Helvetica which is like Arial
  plot(x = df_election_fractions$sec_offset,
       y = rep(0,length(df_election_fractions$sec_offset)),
       main = "", xlab = "", ylab="", xaxt="n", yaxt ="n",
       xlim = xlims, ylim = ylims,
       pch = 20, lty = c("dotted"), type = "n", col = "red", lwd = 1,
       cex = 1, cex.axis = 1, cex.lab = 1, cex.sub = 1, cex.main = 1,
       xaxs ="i", yaxs = "i")
  #
  list.timeline.ticks.rslt <- draw.timeline.ticks.labels(xlims = xlims, ylims = ylims)
  x.axis.label <- list.timeline.ticks.rslt[["x.axis.label"]]
  lab.list.x.pos <- list.timeline.ticks.rslt[["lab.list.x.pos"]]
  #
  par(family="mono") # By default Courier
  lab.list.y.pos <- seq(ylims[1], ylims[2], (ylims[2] - ylims[1]) / 35)
  if(ylims[2] - ylims[1] > 9999000)
  {
    lab.list.y.text <- sprintf("%04dM", round(lab.list.y.pos/1000000, 0))
  } else if(ylims[2] - ylims[1] > 9999)
  {
    lab.list.y.text <- sprintf("%04dK", round(lab.list.y.pos/1000, 0))
  } else
  {
    lab.list.y.text <- sprintf("%04d", round(lab.list.y.pos/1, 0))
  }
  axis(side = 2, at = lab.list.y.pos, labels = lab.list.y.text,
       las = 2, cex.axis = 0.75, padj = 1, mgp = c(3, 0, 0), font.axis=2)
  abline(h=lab.list.y.pos,col = "lightgray", lty = "dotted", lwd = 1)
  #
  options(digits.secs = 3)
  min_time <- gsub("\\.",":",format(as.POSIXct(xlims[1], origin = "1970-01-01"), "%Y-%m-%d, %H:%M:%OS"))
  max_time <- gsub("\\.",":",format(as.POSIXct(xlims[2], origin = "1970-01-01"), "%Y-%m-%d, %H:%M:%OS"))
  title(main = paste0("Cumulative votes results in US ", sapply(gsub("president","presidential",race),simpleCap),
                      " General Election 2020 in ",
                      sapply(state_name,simpleCap)), line=3, cex.main=1.1)
  title(main = paste0("from ", min_time, " to ", max_time), line=2.2, cex.main=1.1)
  #title(main = "Final Tally %", line=-1, cex.main=1)
  title(ylab="Vote Counts for Choices",
        line=2.2, cex.lab=1, font.lab=2)
  title(xlab=x.axis.label,
        line=2, cex.lab=1, font.lab=2)
  #title(xlab=paste0("Data source: ", json_url), line=3, cex.lab=0.75, font.lab=3)
  title(xlab=bquote(bold('Data Source (replace "-"): ') ~ italic(.(json_url))),
        line=2.75, cex.lab=0.75, font.lab=3, col.lab = "darkgreen")
  title(xlab=bquote(bold('Code source: ') ~ italic(.(my_github_base))),
        line=3.5, cex.lab=0.75, font.lab=3, col.lab = "darkgreen")
  options(digits.secs = 3)
  current_time <- gsub("\\.",":",format(Sys.time(), "%Y:%m:%d:%H:%M:%OS"))
  title(xlab=bquote(bold('Current time: ') ~ italic(.(current_time))),
        line=4, cex.lab=0.7, font.lab=3, col.lab = "red")
  #
  lines(x = df_election_fractions$sec_offset,
        y = df_election_fractions$vote_counts_democrat_lb,
        pch = 20, lty = c("dotted"), type = "l", col = "blue", lwd = 1,
        xaxt="n", yaxt ="n")
  lines(x = df_election_fractions$sec_offset,
        y = df_election_fractions$vote_counts_democrat_ub,
        pch = 20, lty = c("dotted"), type = "l", col = "blue", lwd = 1,
        xaxt="n", yaxt ="n")
  lines(x = df_election_fractions$sec_offset,
        y = df_election_fractions$vote_counts_republican_lb,
        pch = 20, lty = c("dotted"), type = "l", col = "red", lwd = 1,
        xaxt="n", yaxt ="n")
  lines(x = df_election_fractions$sec_offset,
        y = df_election_fractions$vote_counts_republican_ub,
        pch = 20, lty = c("dotted"), type = "l", col = "red", lwd = 1,
        xaxt="n", yaxt ="n")
  lines(x = df_election_fractions$sec_offset,
        y = df_election_fractions$vote_counts_democrat,
        pch = 20, lty = c("solid"), type = "l", col = "blue", lwd = 1,
        xaxt="n", yaxt ="n")
  lines(x = df_election_fractions$sec_offset,
        y = df_election_fractions$vote_counts_republican,
        pch = 20, lty = c("solid"), type = "l", col = "red", lwd = 1,
        xaxt="n", yaxt ="n")
  abline(h=df_election_fractions$vote_counts_republican[n], col=c("red"),lwd=c(1),lty=c("dashed"))
  abline(h=df_election_fractions$vote_counts_democrat[n], col=c("blue"),lwd=c(1),lty=c("dashed"))
  #abline(h=ylims[1], col = c("black"), lwd=c(1), lty=c("dashed"))
  return(lab.list.x.pos)
}

compute.ylims.left.cum.vote.fracs <- function(df_election_fractions, xlims)
{
  ylims <- c(min(df_election_fractions$vote_shares_republican[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                 df_election_fractions$vote_shares_democrat[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                 na.rm = TRUE) * 100 / 1.1,
             max(df_election_fractions$vote_shares_republican[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                 df_election_fractions$vote_shares_democrat[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
                 na.rm = TRUE) * 100 * 1.1)
  return(ylims)
}
  
plot.cumulative.vote.fracs <- function(df_election_fractions, xlims,
                                        race, state_name, json_url, my_github_base,
                                       ylims.cumulative.vote.fractions = NULL)
{
  if(is.null(ylims.cumulative.vote.fractions))
  {
    ylims <- compute.ylims.left.cum.vote.fracs(df_election_fractions, xlims)
  } else
  {
    ylims <- ylims.cumulative.vote.fractions
  }

  n <- nrow(df_election_fractions)
  par(family="sans") # By default Helvetica which is like Arial
  plot(x = df_election_fractions$sec_offset,
       y = rep(df_election_fractions$vote_shares_democrat[n] * 100,
               length(df_election_fractions$sec_offset)),
       main = "", xlab = "", ylab="", xaxt="n", yaxt ="n",
       xlim = xlims, ylim = ylims,
       pch = 20, lty = c("dotted"), type = "n", col = "red", lwd = 1,
       cex = 1, cex.axis = 1, cex.lab = 1, cex.sub = 1, cex.main = 1,
       xaxs ="i", yaxs = "i", xpd = F)
  #
  list.timeline.ticks.rslt <- draw.timeline.ticks.labels(xlims = xlims, ylims = ylims)
  x.axis.label <- list.timeline.ticks.rslt[["x.axis.label"]]
  lab.list.x.pos <- list.timeline.ticks.rslt[["lab.list.x.pos"]]
  #
  par(family="mono") # By default Courier
  lab.list.y.pos <- seq(ylims[1], ylims[2], (ylims[2] - ylims[1]) / 35)
  lab.list.y.text <- sprintf("%05.2f", round(lab.list.y.pos,2))
  axis(side = 2, at = lab.list.y.pos, labels = lab.list.y.text,
       las = 2, cex.axis = 0.75, padj = 1, mgp = c(3, 0, 0), font.axis=2)
  abline(h=lab.list.y.pos,col = "lightgray", lty = "dotted", lwd = 1)
  #
  options(digits.secs = 3)
  min_time <- gsub("\\.",":",format(as.POSIXct(xlims[1], origin = "1970-01-01"), "%Y-%m-%d, %H:%M:%OS"))
  max_time <- gsub("\\.",":",format(as.POSIXct(xlims[2], origin = "1970-01-01"), "%Y-%m-%d, %H:%M:%OS"))
  #title(main = "Impacts of vote batches on the", line=3.4, cex.main=1)
  title(main = paste0("Cumulative vote percent results in US ", sapply(gsub("president","presidential",race),simpleCap),
                      " General Election 2020 in ",
                      sapply(state_name,simpleCap)), line=3, cex.main=1.1)
  title(main = paste0("from ", min_time, " to ", max_time), line=2.2, cex.main=1.1)
  #title(main = "Final Tally %", line=-1, cex.main=1)
  title(ylab="Vote Percent for Choices",
        line=2.2, cex.lab=1, font.lab=2)
  title(xlab=x.axis.label,
        line=2, cex.lab=1, font.lab=2)
  #title(xlab=paste0("Data source: ", json_url), line=3, cex.lab=0.75, font.lab=3)
  title(xlab=bquote(bold('Data Source (replace "-"): ') ~ italic(.(json_url))),
        line=2.75, cex.lab=0.75, font.lab=3, col.lab = "darkgreen")
  title(xlab=bquote(bold('Code source: ') ~ italic(.(my_github_base))),
        line=3.5, cex.lab=0.75, font.lab=3, col.lab = "darkgreen")
  options(digits.secs = 3)
  current_time <- gsub("\\.",":",format(Sys.time(), "%Y:%m:%d:%H:%M:%OS"))
  title(xlab=bquote(bold('Current time: ') ~ italic(.(current_time))),
        line=4, cex.lab=0.7, font.lab=3, col.lab = "red")
  #title(xlab = expression("black" * phantom("red") * ")"), col.lab = "black")
  #title(xlab = expression(phantom("black") * "red"), col.lab = "red")
  #
  lines(x = df_election_fractions$sec_offset,
        y = df_election_fractions$vote_shares_democrat_lb * 100,
        pch = 20, lty = c("dotted"), type = "l", col = "blue", lwd = 1,
        xaxt="n", yaxt ="n")
  lines(x = df_election_fractions$sec_offset,
        y = df_election_fractions$vote_shares_democrat_ub * 100,
        pch = 20, lty = c("dotted"), type = "l", col = "blue", lwd = 1,
        xaxt="n", yaxt ="n")
  lines(x = df_election_fractions$sec_offset,
        y = df_election_fractions$vote_shares_republican_lb * 100,
        pch = 20, lty = c("dotted"), type = "l", col = "red", lwd = 1,
        xaxt="n", yaxt ="n")
  lines(x = df_election_fractions$sec_offset,
        y = df_election_fractions$vote_shares_republican_ub * 100,
        pch = 20, lty = c("dotted"), type = "l", col = "red", lwd = 1,
        xaxt="n", yaxt ="n")
  lines(x = df_election_fractions$sec_offset,
        y = df_election_fractions$vote_shares_democrat * 100,
        pch = 20, lty = c("solid"), type = "l", col = "blue", lwd = 1,
        xaxt="n", yaxt ="n")
  lines(x = df_election_fractions$sec_offset,
        y = df_election_fractions$vote_shares_republican * 100,
        pch = 20, lty = c("solid"), type = "l", col = "red", lwd = 1,
        xaxt="n", yaxt ="n")
  
  abline(h=df_election_fractions$vote_shares_republican[n] * 100, col=c("red"),lwd=c(1),lty=c("dashed"))
  abline(h=df_election_fractions$vote_shares_democrat[n] * 100, col=c("blue"),lwd=c(1),lty=c("dashed"))
  return(lab.list.x.pos)
}

plot.cumulative.tally.percent <- function(df_election_fractions = df_election_fractions, xlims = xlims,
                                          lab.list.x.pos = lab.list.x.pos)
{
  ylims <- c(min(df_election_fractions$votes_pct[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]], na.rm = TRUE),
             max(df_election_fractions$votes_pct[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]], na.rm = TRUE))
  plot(x = df_election_fractions$sec_offset[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
       y = df_election_fractions$votes_pct[df_election_fractions$sec_offset >= xlims[1] & df_election_fractions$sec_offset <= xlims[2]],
       main = "", xlab = "", ylab="", xaxt="n", yaxt ="n",
       xlim = xlims, ylim = ylims,
       pch = 20, lty = c("solid"), type = "l", col = "black", lwd = 1,
       cex = 1, cex.axis = 1, cex.lab = 1, cex.sub = 1, cex.main = 1,
       xaxs ="i", yaxs = "i")
  abline(h=100, col = c("black"), lwd=c(1), lty=c("dashed"))
  par(family="mono") # By default Courier
  lab.list.x.upper.pos <- lab.list.x.pos
  increment_secs <- lab.list.x.upper.pos[2] - lab.list.x.upper.pos[1]
  approx.rslt <- approx(x = df_election_fractions$sec_offset,
                        y = df_election_fractions$votes_pct,
                        xout = lab.list.x.upper.pos, method = "linear", rule = 2)
  lab.list.x.upper.text <- sprintf("%05.2f", round(approx.rslt$y,2))
  m <- length(lab.list.x.upper.text)
  axis(side = 3, at = lab.list.x.upper.pos, labels = FALSE)
  text(x = lab.list.x.upper.pos[1:(m-1)] + 0.55 * increment_secs, y = ylims[2], labels = lab.list.x.upper.text[1:(m-1)],
       srt = 90, pos = 3, xpd = TRUE, cex = 0.75, offset = 1)
  mtext(expression(paste(bold("Final Tally %"))), side=3, line=-1, font.lab=2)
  return(ylims)
}

generate.plots.for.all.intervals <- function(str.input.file.path,
                                             str.output.file.path,
                                             json_url_base,
                                             my_github_base,
                                             race_strings,
                                             president_state_strings,
                                             senate_state_strings,
                                             special_state_strings,
                                             list_state_to_abbr,
                                             str_election_date_abbr = "201103",
                                             str_plot_type_abbr)
{
  for(ts.type in c("cf", "cv", "ii")) # cumulative fraction, cumulative vote, incremental impact
  {
    generate.plots.for.all.intervals.by.ts.type(str.input.file.path = str.input.file.path,
                                                str.output.file.path = str.output.file.path,
                                                json_url_base = json_url_base,
                                                my_github_base = my_github_base,
                                                race_strings = race_strings,
                                                president_state_strings = president_state_strings,
                                                senate_state_strings = senate_state_strings,
                                                special_state_strings = special_state_strings,
                                                list_state_to_abbr = list_state_to_abbr,
                                                ts.type = ts.type,
                                                str_election_date_abbr = str_election_date_abbr,
                                                str_plot_type_abbr = str_plot_type_abbr)
  }
}

compute.time.last.flip <- function(df_election_fractions)
{
  n <- nrow(df_election_fractions)
  indices.flips <- which((df_election_fractions$vote_shares_republican[2:n] > df_election_fractions$vote_shares_democrat[2:n] &
                            df_election_fractions$vote_shares_republican[1:(n-1)] <= df_election_fractions$vote_shares_democrat[1:(n-1)]) |
                           (df_election_fractions$vote_shares_republican[2:n] < df_election_fractions$vote_shares_democrat[2:n] &
                              df_election_fractions$vote_shares_republican[1:(n-1)] >= df_election_fractions$vote_shares_democrat[1:(n-1)]) |
                           (df_election_fractions$vote_shares_republican[2:n] >= df_election_fractions$vote_shares_democrat[2:n] &
                              df_election_fractions$vote_shares_republican[1:(n-1)] < df_election_fractions$vote_shares_democrat[1:(n-1)]) |
                           (df_election_fractions$vote_shares_republican[2:n] <= df_election_fractions$vote_shares_democrat[2:n] &
                              df_election_fractions$vote_shares_republican[1:(n-1)] > df_election_fractions$vote_shares_democrat[1:(n-1)]))
  if(length(indices.flips) > 0)
  {
    index.last.flip <- max(indices.flips)
    index.last.flip <- min(index.last.flip + 1, n)
    int.time.last.flip <- df_election_fractions$sec_offset[index.last.flip]
  } else
  {
    int.time.last.flip <- NA
  }
  return(int.time.last.flip)
}

generate.plots.for.all.intervals.by.ts.type <- function(str.input.file.path,
                                                        str.output.file.path,
                                                        json_url_base,
                                                        my_github_base,
                                                        race_strings,
                                                        president_state_strings,
                                                        senate_state_strings,
                                                        special_state_strings,
                                                        list_state_to_abbr,
                                                        ts.type,
                                                        str_election_date_abbr = "201103",
                                                        str_plot_type_abbr)
{
  pdf_output_path <- paste0(str.output.file.path,"/pdf")
  pdf_file_name_comp_date <- str_election_date_abbr
  pdf_file_name_comp_plot_type <- str_plot_type_abbr
  for(race_index in 1:length(race_strings))
  {
    race <- race_strings[race_index]
    if(race == "special")
    {
      url_string <- "senate/0/special.json"
      pdf_file_name_comp_race <- "sp"
      state_strings <- special_state_strings
    } else if (race == "president")
    {
      url_string <- "president.json"
      pdf_file_name_comp_race <- "pr"
      state_strings <- president_state_strings
    } else if (race == "senate")
    {
      url_string <- "senate.json"
      pdf_file_name_comp_race <- "se"
      state_strings <- senate_state_strings
    } else
    {
      url_string <- ""
      pdf_file_name_comp_race <- ""
      state_strings <- NULL
    }
    for(state_index in 1:length(state_strings))
    {
      state_name <- state_strings[state_index]
      pdf_file_name_comp_state <- list_state_to_abbr[[state_name]]
      json_url <- paste0(json_url_base, "/", state_name, "/", url_string)
      df_election_fractions <- read.csv.prepare.fraction.data(
        str.input.file.path = str.input.file.path, state_name = state_name, race = race)
      if(!is.null(df_election_fractions))
      {
        pdf_file_name_comp_ts <- ts.type # "cf", "cv", or "ii";  # cumulative fraction, cumulative vote, incremental impact
        int.time.last.flip <- compute.time.last.flip(df_election_fractions = df_election_fractions)
        #
        options(digits.secs = 0)
        n <- nrow(df_election_fractions)
        int_global_min_time <- df_election_fractions$sec_offset[1]
        int_global_max_time <- df_election_fractions$sec_offset[n]
        str_global_min_time <- format(as.POSIXct(
          int_global_min_time, origin = "1970-01-01"),"%Y-%m-%dT%H:%M:%OSZ")
        str_global_max_time <- format(as.POSIXct(
          int_global_max_time, origin = "1970-01-01"),"%Y-%m-%dT%H:%M:%OSZ")
        window.curr.size           <- 1
        window.curr.size.mult      <- 1
        window.shift.mult          <- 1
        int_curr_min_time <- int_global_min_time
        int_curr_max_time <- int_global_max_time
        str_curr_min_time <- str_global_min_time
        str_curr_max_time <- str_global_max_time
        #
        pdf_file_name <- paste0(pdf_file_name_comp_date, "_",
                                pdf_file_name_comp_plot_type,"_",
                                pdf_file_name_comp_state, "_",
                                pdf_file_name_comp_race, "_",
                                pdf_file_name_comp_ts, ".pdf")
        pdf(file=paste0(pdf_output_path,"/",pdf_file_name), width=11, height=8.5, paper="special")
        #CairoPDF(file=paste0(pdf_output_path,"/",pdf_file_name), width=11, height=8.5, paper="special")
        #cairo_pdf(file=paste0(pdf_output_path,"/",pdf_file_name), width=11, height=8.5)
        while(TRUE)
        {
          #str_curr_min_time = "2020-11-03T21:00:00Z"
          #str_curr_max_time = "2020-11-05T00:00:00Z"
          if(pdf_file_name_comp_ts == "cf")
          {
            plot.cumulative.vote.fractions(
              str_curr_min_time = str_curr_min_time,
              str_curr_max_time = str_curr_max_time,
              df_election_fractions = df_election_fractions,
              race = race,
              state_name = state_name,
              json_url = json_url,
              my_github_base = my_github_base,
              int.time.last.flip = int.time.last.flip)
          } else if(pdf_file_name_comp_ts == "cv")
          {
            plot.cumulative.votes(
              str_curr_min_time = str_curr_min_time,
              str_curr_max_time = str_curr_max_time,
              df_election_fractions = df_election_fractions,
              race = race,
              state_name = state_name,
              json_url = json_url,
              my_github_base = my_github_base,
              int.time.last.flip = int.time.last.flip)
          } else if(pdf_file_name_comp_ts == "ii")
          {
            plot.batch.impact(
              str_curr_min_time = str_curr_min_time,
              str_curr_max_time = str_curr_max_time,
              df_election_fractions = df_election_fractions,
              race = race,
              state_name = state_name,
              json_url = json_url,
              my_github_base = my_github_base,
              int.time.last.flip = int.time.last.flip)
          }
          # if there is space to the right, shift the window to the right (never go beyond the global right boundary)
          if(int_curr_max_time < int_global_max_time)
          {
            int_curr_min_time <- int_curr_min_time + (int_global_max_time - int_global_min_time) *
              window.curr.size * window.curr.size.mult * window.shift.mult
            window.curr.size.mult <- window.curr.size.mult * 2
            int_curr_max_time <- int_curr_min_time + (int_global_max_time - int_global_min_time) *
              window.curr.size * window.curr.size.mult
            if(int_curr_max_time > int_global_max_time)
            {
              window.curr.size.mult <- 1
              window.curr.size <- window.curr.size * (1/2)
              int_curr_min_time <- int_global_min_time
              int_curr_max_time <- int_curr_min_time + (int_global_max_time - int_global_min_time) *
                window.curr.size * window.curr.size.mult
            }
          } else # else reset the window to the left most position with reduced size
          {
            window.curr.size.mult <- 1
            window.curr.size <- window.curr.size * (1/2)
            int_curr_min_time <- int_global_min_time
            int_curr_max_time <- int_curr_min_time + (int_global_max_time - int_global_min_time) *
              window.curr.size * window.curr.size.mult
          }
          # break the loop if the new window size is too small and it was shifted
          if(int_curr_min_time == int_global_min_time & (int_curr_max_time - int_curr_min_time) < 3600 / 1)
          {
            break
          }
          str_curr_min_time <- format(as.POSIXct(
            int_curr_min_time, origin = "1970-01-01"),"%Y-%m-%dT%H:%M:%OSZ")
          str_curr_max_time <- format(as.POSIXct(
            int_curr_max_time, origin = "1970-01-01"),"%Y-%m-%dT%H:%M:%OSZ")
        } # END while(TRUE)
        dev.off()
      } # END if(!is.null(df_election_fractions))
    } # END for(state_index in 1:length(state_strings))
  } # END for(race_index in 1:length(race_strings))
} # END generate.plots.for.all.intervals.by.ts.type

generate.plots.for.all.states <- function(str.input.file.path,
                                          str.output.file.path,
                                          json_url_base,
                                          my_github_base,
                                          race_strings,
                                          president_state_strings,
                                          senate_state_strings,
                                          special_state_strings,
                                          list_state_to_abbr,
                                          str_election_date_abbr = "201103",
                                          str_plot_type_abbr)
{
  pdf_output_path <- paste0(str.output.file.path,"/pdf")
  pdf_file_name_comp_date <- str_election_date_abbr
  pdf_file_name_comp_plot_type <- str_plot_type_abbr
  for(state_index in 1:length(president_state_strings))
  {
    state_name <- president_state_strings[state_index]
    #str_curr_min_time = "2020-11-03T21:00:00Z"
    #str_curr_max_time = "2020-11-05T00:00:00Z"
    str_curr_min_time <- list_state_to_interval[[state_name]][["from"]]
    str_curr_max_time <- list_state_to_interval[[state_name]][["to"]]
    pdf_file_name_comp_state <- list_state_to_abbr[[state_name]]
    pdf_file_name <- paste0(pdf_file_name_comp_date, "_",
                            pdf_file_name_comp_plot_type, "_",
                            pdf_file_name_comp_state, ".pdf")
    pdf(file=paste0(pdf_output_path,"/",pdf_file_name), width=11, height=8.5, paper="special")
    for(ts.type in c("cf", "cv", "ii")) # cumulative fraction, cumulative vote, incremental impact
    {
      pdf_file_name_comp_ts <- ts.type # "cf", "cv", or "ii";  # cumulative fraction, cumulative vote, incremental impact

      # Iterate over races and compute Y-limits for both the left and the right y-axis.
      # Use these global limits to overwrite the subsequent calls.
      ylims.cumulative.vote.fractions <- NULL
      ylims.cumulative.votes <- NULL
      ylims.batch.impact <- NULL
      ylims.batch.size <- NULL
      for(race_index in 1:length(race_strings))
      {
        race <- race_strings[race_index]
        is.race.available <-
          ((race == "special" & state_name %in% special_state_strings) |
          (race == "president" & state_name %in% president_state_strings) |
          (race == "senate" & state_name %in% senate_state_strings))
        if(is.race.available)
        {
          df_election_fractions <- read.csv.prepare.fraction.data(
            str.input.file.path = str.input.file.path, state_name = state_name, race = race)
          if(!is.null(df_election_fractions))
          {
            # Use "str_curr_min_time" and "str_curr_max_time" on "df_election_fractions"
            # to update ylims ("ylims.cumulative.vote.fractions", "ylims.cumulative.votes", "ylims.batch.impact", "ylims.vote.tally")
            xlims <- compute.xlims.lower.time(
              str_curr_min_time = str_curr_min_time,
              str_curr_max_time = str_curr_max_time,
              df_election_fractions = df_election_fractions)
            ylims.left.cum.vote.fracs <- compute.ylims.left.cum.vote.fracs(
              df_election_fractions = df_election_fractions, xlims = xlims)
            if(is.null(ylims.cumulative.vote.fractions))
            {
              ylims.cumulative.vote.fractions <- ylims.left.cum.vote.fracs
            } else
            {
              ylims.cumulative.vote.fractions[1] <- min(ylims.cumulative.vote.fractions[1], ylims.left.cum.vote.fracs[1])
              ylims.cumulative.vote.fractions[2] <- max(ylims.cumulative.vote.fractions[2], ylims.left.cum.vote.fracs[2])
            }
            ylims.left.cum.votes <- compute.ylims.left.cum.votes(
              df_election_fractions = df_election_fractions, xlims = xlims)
            if(is.null(ylims.cumulative.votes))
            {
              ylims.cumulative.votes <- ylims.left.cum.votes
            } else
            {
              ylims.cumulative.votes[1] <- min(ylims.cumulative.votes[1], ylims.left.cum.votes[1])
              ylims.cumulative.votes[2] <- max(ylims.cumulative.votes[2], ylims.left.cum.votes[2])
            }
            ylims.left.batch.impact.statistic <- compute.ylims.left.batch.impact.statistic(
              df_election_fractions = df_election_fractions, xlims = xlims)            
            if(is.null(ylims.batch.impact))
            {
              ylims.batch.impact <- ylims.left.batch.impact.statistic
            } else
            {
              ylims.batch.impact[1] <- min(ylims.batch.impact[1], ylims.left.batch.impact.statistic[1])
              ylims.batch.impact[2] <- max(ylims.batch.impact[2], ylims.left.batch.impact.statistic[2])
            }
            list.ylims.right.batch.size.info <- compute.ylims.right.batch.size(
              df_election_fractions = df_election_fractions, xlims = xlims)
            ylims.right.batch.size <- list.ylims.right.batch.size.info[["ylims"]]
            if(is.null(ylims.batch.size))
            {
              ylims.batch.size <- ylims.right.batch.size
            } else
            {
              ylims.batch.size[1] <- min(ylims.batch.size[1], ylims.right.batch.size[1])
              ylims.batch.size[2] <- max(ylims.batch.size[2], ylims.right.batch.size[2])
            }
          } # END if(!is.null(df_election_fractions))
        } # END if(is.race.available)
      } # END for(race_index in 1:length(race_strings))
      #
      for(race_index in 1:length(race_strings))
      {
        race <- race_strings[race_index]
        is.race.available <-
          ((race == "special" & state_name %in% special_state_strings) |
             (race == "president" & state_name %in% president_state_strings) |
             (race == "senate" & state_name %in% senate_state_strings))
        if(is.race.available)
        {
          df_election_fractions <- read.csv.prepare.fraction.data(
            str.input.file.path = str.input.file.path, state_name = state_name, race = race)
          if(!is.null(df_election_fractions))
          {
            int.time.last.flip <- compute.time.last.flip(df_election_fractions = df_election_fractions)
            if(race == "special")
            {
              url_string <- "senate/0/special.json"
            } else if (race == "president")
            {
              url_string <- "president.json"
            } else if (race == "senate")
            {
              url_string <- "senate.json"
            } else
            {
              url_string <- ""
            }
            json_url <- paste0(json_url_base, "/", state_name, "/", url_string)
            if(pdf_file_name_comp_ts == "cf")
            {
              plot.cumulative.vote.fractions(
                str_curr_min_time = str_curr_min_time,
                str_curr_max_time = str_curr_max_time,
                df_election_fractions = df_election_fractions,
                race = race,
                state_name = state_name,
                json_url = json_url,
                my_github_base = my_github_base,
                int.time.last.flip = int.time.last.flip,
                ylims.batch.size = ylims.batch.size,
                ylims.cumulative.vote.fractions = ylims.cumulative.vote.fractions)
            } else if(pdf_file_name_comp_ts == "cv")
            {
              plot.cumulative.votes(
                str_curr_min_time = str_curr_min_time,
                str_curr_max_time = str_curr_max_time,
                df_election_fractions = df_election_fractions,
                race = race,
                state_name = state_name,
                json_url = json_url,
                my_github_base = my_github_base,
                int.time.last.flip = int.time.last.flip,
                ylims.batch.size = ylims.batch.size,
                ylims.cumulative.votes = ylims.cumulative.votes)
            } else if(pdf_file_name_comp_ts == "ii")
            {
              plot.batch.impact(
                str_curr_min_time = str_curr_min_time,
                str_curr_max_time = str_curr_max_time,
                df_election_fractions = df_election_fractions,
                race = race,
                state_name = state_name,
                json_url = json_url,
                my_github_base = my_github_base,
                int.time.last.flip = int.time.last.flip,
                ylims.batch.size = ylims.batch.size,
                ylims.batch.impact = ylims.batch.impact)
            }
          } # END if(!is.null(df_election_fractions))
        } # END if(is.race.available)
      } # END for(race_index in 1:length(race_strings))
    } # END for(ts.type in c("cf", "cv", "ii"))
    dev.off()
  } # END for(state_index in 1:length(president_state_strings))
} # END generate.plots.for.all.states <- function
